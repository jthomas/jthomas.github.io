<!DOCTYPE html>
<html lang="en">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.69.2" />

    
    
    

<title>Using Cloud Object Storage from IBM Cloud Functions (Node.js) ‚Ä¢ notes on software.</title>
<meta name="description" content="James Thomas&#39; blog about software. Posts about serverless, cloud platforms, openwhisk, node.js and more...">
<meta name="keywords" content="blog,serverless,openwhisk,ibm,nodejs,tensorflow,serverless framework,open-source,conferences,developer advocacy,github">
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Using Cloud Object Storage from IBM Cloud Functions (Node.js)"/>
<meta name="twitter:description" content="How to use IBM Cloud Object Storage to store files for IBM Cloud Functions serverless applications. Demonstrating service provisioning, using client libraries and example code for the Node.js runtime."/>

<meta property="og:title" content="Using Cloud Object Storage from IBM Cloud Functions (Node.js)" />
<meta property="og:description" content="How to use IBM Cloud Object Storage to store files for IBM Cloud Functions serverless applications. Demonstrating service provisioning, using client libraries and example code for the Node.js runtime." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jamesthom.as/2018/05/using-cloud-object-storage-from-ibm-cloud-functions-node.js/" />
<meta property="article:published_time" content="2018-05-31T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-05-31T00:00:00+00:00" />


    






<link rel="stylesheet" href="/scss/hyde-hyde.3081c4981fb69a2783dd36ecfdd0e6ba7a158d4cbfdd290ebce8f78ba0469fc6.css" integrity="sha256-MIHEmB&#43;2mieD3Tbs/dDmunoVjUy/3SkOvOj3i6BGn8Y=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    <style type="text/css">
.content {
  max-width: 48rem;
}

.sidebar .container {
  padding-right: 0rem;
  padding-left: 0rem;
}

h1 {
  margin-top: 0;
}
</style>

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://jamesthom.as/">notes on software.</a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="https://jamesthom.as/profile.jpg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
         by james thomas serverless aficionado. 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">notes on software.</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/about/">
						<span>About</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/posts/">
						<span>Posts</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/thomasj" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://github.com/jthomas" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	<a href="https://stackoverflow.com/users/1427084" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://medium.com/@jamesthom.as" rel="me"><i class="fab fa-medium fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
        
	<a href="https://www.youtube.com/user/jthomasuk" rel="me"><i class="fab fa-youtube fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="mailto:blog@jamesthom.as" rel="me"><i class="fas fa-at fa-lg" aria-hidden="true"></i></a>
	
</section>

      </div>
    </div>
    


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>Using Cloud Object Storage from IBM Cloud Functions (Node.js)</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> May 31, 2018
    
    
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/openwhisk">openwhisk</a>
           
      
          <a class="badge badge-tag" href="/tags/serverless">serverless</a>
           
      
          <a class="badge badge-tag" href="/tags/nodejs">nodejs</a>
           
      
          <a class="badge badge-tag" href="/tags/object-storage">object-storage</a>
           
      
          <a class="badge badge-tag" href="/tags/stmm">stmm</a>
          
      
    
    
    <br/>
    
    <i class="fas fa-clock"></i> 18 min read
    
</div>


  </header>
  
  
  <div class="post">
    <p>How do you manage files for a serverless application? ü§î</p>
<p><a href="http://jamesthom.as/blog/2018/04/27/managing-serverless-files-with-ibm-cloud-object-storage/">Previous blog posts</a> discussed this common problem and introduced the most popular solution, using a <a href="https://gigaom.com/2016/11/10/serverless-enabled-storage-its-a-big-deal/">cloud-based object storage service</a>. üëèüëèüëè</p>
<p>Object stores provide elastic storage in the cloud, with a billing model which charges for capacity used. These services are the storage solution for serverless applications, which do not have access to a traditional file system. üëç</p>
<p><strong>I&rsquo;m now going to demonstrate how to use <a href="https://console.bluemix.net/catalog/services/cloud-object-storage">IBM Cloud Object Storage</a> from <a href="https://console.bluemix.net/openwhisk/">IBM Cloud Functions</a>.</strong></p>
<p>This blog post will show you&hellip;</p>
<ul>
<li>How to provision IBM Cloud Object Storage and create authentication tokens.</li>
<li>How use client libraries to access IBM Cloud Object Storage from IBM Cloud Functions.</li>
<li>Example serverless functions for common use-cases, e.g uploading files.</li>
</ul>
<p><a href="https://github.com/jthomas/serverless-file-storage">Code examples</a> in this blog post will focus on the Node.js runtime.</p>
<p><em>Instructions on service provisioning and authentication credentials are relevant for any runtime.</em></p>
<h2 id="ibm-cloud-accounts-and-storage-services">IBM Cloud Accounts and Storage Services</h2>
<p>IBM Cloud Object Storage is available to all IBM Cloud users.</p>
<p>IBM Cloud has <a href="https://console.bluemix.net/docs/account/index.html#accounts">three different account types</a>: <em>lite, pay-as-you-go</em> or <em>subscription</em>.</p>
<h3 id="lite-accounts">Lite Accounts</h3>
<p><a href="https://www.ibm.com/blogs/bluemix/2017/11/introducing-ibm-cloud-lite-account/">Lite accounts</a> do not require a credit card to register and do not expire after a limited time period.</p>
<p>Numerous platform services, including Cloud Object Storage, provide <a href="https://console.bluemix.net/catalog/?search=label:lite">free resources for lite account users</a>. IBM Cloud Object Storage&rsquo;s free resource tier comes the <a href="https://www.ibm.com/cloud-computing/bluemix/pricing-object-storage#s3api">following monthly limits</a>.</p>
<ul>
<li><em>Store 25GB of new data.</em></li>
<li><em>Issue 20,000 GET and 2,000 PUT requests.</em></li>
<li><em>Use 10GB of public bandwidth.</em></li>
</ul>
<p><em>Lite tier usage supports all resiliency and storage class options but are limited to a single service instance.</em></p>
<p>Users can sign up for a free &ldquo;Lite&rdquo; account <a href="https://console.ng.bluemix.net/registration/free">here</a>. Please follow the instructions to <a href="https://console.bluemix.net/docs/cli/reference/bluemix_cli/get_started.html#getting-started">install the IBM Cloud CLI.</a></p>
<h3 id="pay-as-you-go--subscription-accounts">Pay-as-you-Go &amp; Subscription Accounts</h3>
<p>Lite accounts can be upgraded to <a href="https://console.bluemix.net/docs/account/index.html#paygo">Pay-As-You-Go</a> or <a href="https://console.bluemix.net/docs/account/index.html#subscription-account">Subscription</a> accounts. Upgraded accounts still have access to the free tiers provided in Lite accounts. Users with Pay-As-You-Go or Subscriptions accounts can access services and tiers not included in the Lite account.</p>
<p>Benefits of the additional service tiers for IBM Cloud Object Storage include unlimited instances of the object storage service. Costs are billed according to usage per month. See the pricing page for more details: <a href="https://www.ibm.com/cloud-computing/bluemix/pricing-object-storage#s3api">https://www.ibm.com/cloud-computing/bluemix/pricing-object-storage#s3api</a></p>
<h2 id="provisioning-ibm-cloud-object-storage">Provisioning IBM Cloud Object Storage</h2>
<p>IBM Cloud Object Storage can be provisioned through the <a href="https://console.bluemix.net/catalog/">IBM Cloud service catalog</a>.</p>
<p><img src="/images/cos_storage/catalog.png" alt=""></p>
<p>From the <em><a href="https://console.bluemix.net/catalog/services/cloud-object-storage">Service Details</a></em> page, follow these instructions to provision a new instance.</p>
<ul>
<li>Give the service an identifying name.</li>
<li>Leave the resource group as &ldquo;<em>default</em>&quot;.</li>
<li>Click the &ldquo;Create&rdquo; button.</li>
</ul>
<p>Once the service has been provisioned, it will be shown under the &ldquo;Services&rdquo; section of the <a href="https://console.bluemix.net/dashboard/apps">IBM Cloud Dashboard</a>. <strong>IBM Cloud Object Storage services are global services and not bound to individual regions.</strong></p>
<ul>
<li>Click the service instance from the dashboard to visit the service management page.</li>
</ul>
<p><img src="/images/cos_storage/go-to-service-instance.gif" alt=""></p>
<p><em>Once the service has been provisioned, we need to create authentication credentials for external access‚Ä¶</em></p>
<h2 id="service-credentials">Service Credentials</h2>
<p>Service credentials for IBM Cloud Object Storage use <a href="https://console.bluemix.net/docs/services/cloud-object-storage/iam/overview.html#getting-started-with-iam">IBM Cloud&rsquo;s IAM service</a>.</p>
<p>I&rsquo;m just going to cover the basics of using IAM with Cloud Object Storage. Explaining all the <a href="https://console.bluemix.net/docs/iam/index.html#iamoverview">concepts and capabilities</a> of the IAM service would need a separate (and lengthy) blog post!</p>
<h3 id="auto-binding-service-credentials">Auto-Binding Service Credentials</h3>
<p>IBM Cloud Functions can <a href="https://console.bluemix.net/docs/openwhisk/binding_services.html#binding_services">automatically provision and bind service credentials</a> to actions.</p>
<p><em>This feature is supported through the IBM Cloud CLI command: <code>bx wsk service bind</code>.</em></p>
<p>Bound service credentials are stored as default action parameters. Default parameters are automatically included as request parameters for each invocation.</p>
<p><strong>Using this approach means users do not have to manually provision and manage service credentials.</strong> üëç</p>
<p><em>Service credentials provisioned in this manner use the following configuration options:</em></p>
<ul>
<li><strong>IAM Role</strong>: <em>Manager</em></li>
<li><strong>Optional Configuration Parameters</strong>: <em>None</em>.</li>
</ul>
<p>If you need to use different configuration options, you will have to manually provision service credentials.</p>
<h3 id="manually-creating-credentials">Manually Creating Credentials</h3>
<ul>
<li>Select the &ldquo;<em>Service Credentials</em>&rdquo; menu item from the service management page.</li>
<li>Click the &ldquo;New credential&rdquo; button.</li>
</ul>
<p><em>Fill in the details for the new credentials.</em></p>
<ul>
<li>
<p>Choose an identifying name for the credentials.</p>
</li>
<li>
<p>Select an access role. Access roles define which operations applications using these credentials can perform. Permissions for each role are <a href="https://console.bluemix.net/docs/services/cloud-object-storage/iam/buckets.html#bucket-permissions">listed in the documentation</a>.</p>
<p><em>Note: If you want to make objects publicly accessible <a href="https://stackoverflow.com/questions/50007460/ibm-cloud-object-storage-cannot-modify-object-acl-permissions">make sure you use the manager permission</a>.</em></p>
</li>
<li>
<p>Leave the <code>Service ID</code> unselected.</p>
</li>
</ul>
<p>If you need HMAC service keys, which are necessary for generating presigned URLs, use the following inline configuration parameters before. Otherwise, leave this field blank.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{<span style="color:#f92672">&#34;HMAC&#34;</span>: <span style="color:#66d9ef">true</span>}
</code></pre></div><ul>
<li>Click the &ldquo;Add&rdquo; button.</li>
</ul>
<p><img src="/images/cos_storage/provision-credentials.gif" alt=""></p>
<p>üîê <em>Credentials shown in this GIF were deleted after the demo (before you get any ideas&hellip;)</em> üîê</p>
<p>Once created, new service credentials will be shown in the credentials table.</p>
<h2 id="ibm-cloud-object-storage-api">IBM Cloud Object Storage API</h2>
<p>Cloud Object Storage exposes a <a href="https://console.bluemix.net/docs/services/cloud-object-storage/api-reference/about-compatibility-api.html#about-the-ibm-cloud-object-storage-api">HTTP API</a> for interacting with buckets and files.</p>
<p>This API implements the same interface as <a href="https://docs.aws.amazon.com/AmazonS3/latest/API/Welcome.html">AWS S3 API</a>.</p>
<p>Service credentials created above are used to authenticate requests to the API endpoints. Full details on the API operations are available in the <a href="https://console.bluemix.net/docs/services/cloud-object-storage/api-reference/about-compatibility-api.html#about-the-ibm-cloud-object-storage-api">documentation</a>.</p>
<h3 id="http-endpoints">HTTP Endpoints</h3>
<p>IBM Cloud Object Storage&rsquo;s HTTP API is available through <a href="https://console.bluemix.net/docs/services/cloud-object-storage/basics/endpoints.html#select-regions-and-endpoints">region-based endpoints</a>.</p>
<p>When creating new buckets to store files, the data resiliency for the bucket (and therefore the files within it) is based upon the endpoint used for the bucket create operation.</p>
<p>Current endpoints are listed in the <a href="https://console.bluemix.net/docs/services/cloud-object-storage/basics/endpoints.html#select-regions-and-endpoints">external documentation</a> and available through an external API: <a href="https://cos-service.bluemix.net/endpoints">https://cos-service.bluemix.net/endpoints</a></p>
<h4 id="choosing-an-endpoint">Choosing an endpoint</h4>
<p>IBM Cloud Functions is available in the following regions: <em>US-South, United Kingdom and Germany.</em></p>
<p>Accessing Cloud Object Storage using regional endpoints closest to the Cloud Functions application region will result in better application performance.</p>
<p>IBM Cloud Object Storage lists public and private endpoints for each region (and resiliency) choice. <strong>IBM Cloud Functions only supports access using public endpoints.</strong></p>
<p>In the following examples, IBM Cloud Functions applications will be hosted in the <code>US-South</code> region. Using the <code>US Regional</code> endpoint for Cloud Object Storage will minimise network latency when using the service from IBM Cloud Functions.</p>
<p><em>This endpoint will be used in all our examples:</em> <code>s3-api.us-geo.objectstorage.softlayer.net</code></p>
<h3 id="client-libraries">Client Libraries</h3>
<p>Rather than manually creating HTTP requests to interact with the Cloud Object Storage API, <a href="https://console.bluemix.net/docs/services/cloud-object-storage/libraries/node.html#using-node-js">client libraries</a> are available.</p>
<p>IBM Cloud Object Storage publishes modified versions of the Node.js, Python and Java AWS S3 SDKs, enhanced with IBM Cloud specific features.</p>
<ul>
<li><code>ibm-cos-sdk-js</code> - <a href="https://github.com/IBM/ibm-cos-sdk-js">https://github.com/IBM/ibm-cos-sdk-js</a></li>
<li><code>ibm-cos-sdk-python</code> - <a href="https://github.com/ibm/ibm-cos-sdk-python">https://github.com/ibm/ibm-cos-sdk-python</a></li>
<li><code>ibm-cos-sdk-java</code> - <a href="https://github.com/ibm/ibm-cos-sdk-java">https://github.com/ibm/ibm-cos-sdk-java</a></li>
</ul>
<p>Both the Node.js and Python COS libraries are pre-installed in the IBM Cloud Functions <a href="https://github.com/ibm-functions">runtime environments</a> for those languages. They can be used without bundling those dependencies in the deployment package.</p>
<p><em>We&rsquo;re going to look at using the JavaScript client library from the Node.js runtime in IBM Cloud Functions.</em></p>
<h4 id="javascript-client-library">JavaScript Client Library</h4>
<p>When using the JavaScript client library for IBM Cloud Object Storage, endpoint and authentication credentials need to be passed as configuration parameters.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">COS</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;ibm-cos-sdk&#39;</span>);

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">config</span> <span style="color:#f92672">=</span> {
    <span style="color:#a6e22e">endpoint</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;&lt;endpoint&gt;&#39;</span>,
    <span style="color:#a6e22e">apiKeyId</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;&lt;api-key&gt;&#39;</span>,    
    <span style="color:#a6e22e">serviceInstanceId</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;&lt;resource-instance-id&gt;&#39;</span>,
};

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cos</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">COS</span>.<span style="color:#a6e22e">S3</span>(<span style="color:#a6e22e">config</span>);
</code></pre></div><p>Hardcoding configuration values within source code is not recommended. IBM Cloud Functions allows <a href="https://console.bluemix.net/docs/openwhisk/parameters.html#default-params-action">default parameters</a> to be bound to actions. Default parameters are automatically passed into action invocations within the event parameters.</p>
<p><em>Default parameters are recommended for managing application secrets for IBM Cloud Functions applications.</em></p>
<p><strong>Having provisioned the storage service instance, learnt about service credentials, chosen an access endpoint and understood how to use the client library, there&rsquo;s one final step before we can start to creating functions‚Ä¶</strong></p>
<h2 id="creating-buckets">Creating Buckets</h2>
<p>IBM Cloud Object Storage organises files into a flat hierarchy of named containers, called buckets. Buckets can be created <a href="https://console.bluemix.net/docs/services/cloud-object-storage/cli/curl.html#add-a-bucket">through the command-line</a>, <a href="https://console.bluemix.net/docs/services/cloud-object-storage/api-reference/api-reference-buckets.html#new-bucket">using the API</a> or the web console.</p>
<p>Let&rsquo;s create a new bucket, to store all files for our serverless application, using the web console.</p>
<ul>
<li>
<p>Open the &ldquo;<em>Buckets</em>&rdquo; page from the COS management page.</p>
</li>
<li>
<p>Click the &ldquo;<em>Create Bucket</em>&rdquo; link.</p>
</li>
<li>
<p>Create a bucket name.
<em>Bucket names must be unique across the entire platform, rather than just your account.</em></p>
</li>
<li>
<p>Select the following configuration options</p>
<ul>
<li><strong>Resiliency</strong>: <code>Cross Region</code></li>
<li><strong>Location</strong>: <code>us-geo</code></li>
<li><strong>Storage class</strong>: <code>Standard</code></li>
</ul>
</li>
<li>
<p>Click the &ldquo;<em>Create</em>&rdquo; button.</p>
</li>
</ul>
<p><img src="/images/cos_storage/creating-buckets.gif" alt=""></p>
<p><em>Once the bucket has been created, you will be taken back to the bucket management page.</em></p>
<h4 id="test-files">Test Files</h4>
<p>We need to put some test files in our new bucket. Download the following images files.</p>
<ul>
<li><a href="https://cdn.pixabay.com/photo/2015/06/08/15/02/pug-801826_640.jpg">Pug Blanket</a></li>
<li><a href="https://cdn.pixabay.com/photo/2016/07/07/15/35/swimming-1502563_640.jpg">Swimming Pug</a></li>
<li><a href="https://cdn.pixabay.com/photo/2017/02/28/13/11/dog-2105686_640.jpg">Jumping Pug</a></li>
</ul>
<p><strong>Using the bucket management page, upload these files to the new bucket.</strong></p>
<p><img src="/images/cos_storage/upload-files.png" alt=""></p>
<h2 id="using-cloud-object-storage-from-cloud-functions">Using Cloud Object Storage from Cloud Functions</h2>
<p>Having created a storage bucket containing test files, we can start to develop our <a href="https://github.com/jthomas/serverless-file-storage">serverless application</a>.</p>
<p>Let&rsquo;s begin with a serverless function that returns a list of files within a bucket. Once this works, we will extend the application to support retrieving, removing and uploading files to a bucket. We can also show how to make objects publicly accessible and generate pre-signed URLs, allowing external clients to upload new content directly.</p>
<p><a href="https://github.com/jthomas/serverless-file-storage">Separate IBM Cloud Functions actions</a> will be created for each storage operation.</p>
<h3 id="managing-default-parameters">Managing Default Parameters</h3>
<p>Serverless functions will need the bucket name, service endpoint and authentication parameters to access the object storage service. Configuration parameters will be bound to actions as <a href="https://console.bluemix.net/docs/openwhisk/parameters.html#default-params-action">default parameters</a>.</p>
<p>Packages can be used to share configuration values across multiple actions. Actions created within a package inherit all <a href="https://console.bluemix.net/docs/openwhisk/parameters.html#default-params-package">default parameters stored on that package</a>. This removes the need to manually configure the same default parameters for each action.</p>
<p>Let&rsquo;s create a new package (<code>serverless-files</code>) for our serverless application.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ bx wsk package create serverless-files
ok: created package serverless-files
</code></pre></div><p>Update the package with default parameters for the bucket name (<code>bucket</code>) and service endpoint (<code>cos_endpoint</code>).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ bx wsk package update serverless-files -p bucket &lt;MY_BUCKET_NAME&gt; -p cos_endpoint s3-api.us-geo.objectstorage.softlayer.net
ok: updated package serverless-files
</code></pre></div><p><em><strong>Did you notice we didn&rsquo;t provide authentication credentials as default parameters?</strong></em></p>
<p>Rather than manually adding these credentials, the CLI can <a href="https://console.bluemix.net/docs/openwhisk/binding_services.html#binding_services">automatically provision and bind them</a>. Let&rsquo;s do this now for the <code>cloud-object-storage</code> service&hellip;</p>
<ul>
<li>Bind service credentials to the <code>serverless-files</code> package using the <code>bx wsk service bind</code> command.</li>
</ul>
<pre><code>$ bx wsk service bind cloud-object-storage serverless-files
Credentials 'cloud-fns-key' from 'cloud-object-storage' service instance 'object-storage' bound to 'serverless-files'.
</code></pre><ul>
<li>Retrieve package details to check default parameters contain expected configuration values.</li>
</ul>
<pre><code>$ bx wsk package get serverless-files
ok: got package serverless-files
{
    ...    
    &quot;parameters&quot;: [
        {
            &quot;key&quot;: &quot;bucket&quot;,
            &quot;value&quot;: &quot;&lt;MY_BUCKET_NAME&gt;&quot;
        },
        {
            &quot;key&quot;: &quot;cos_endpoint&quot;,
            &quot;value&quot;: &quot;s3-api.us-geo.objectstorage.softlayer.net&quot;
        },
        {
            &quot;key&quot;: &quot;__bx_creds&quot;,
            &quot;value&quot;: {
                &quot;cloud-object-storage&quot;: {
                    ...
                }
            }
        }
    ]
}
</code></pre><h3 id="list-objects-within-the-bucket">List Objects Within the Bucket</h3>
<ul>
<li>Create a new file (<code>action.js</code>) with the following contents.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">COS</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;ibm-cos-sdk&#39;</span>)

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">cos_client</span> (<span style="color:#a6e22e">params</span>) {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">bx_creds</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">params</span>[<span style="color:#e6db74">&#39;__bx_creds&#39;</span>]
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">bx_creds</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;Missing __bx_creds parameter.&#39;</span>)

  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cos_creds</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">bx_creds</span>[<span style="color:#e6db74">&#39;cloud-object-storage&#39;</span>]
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">cos_creds</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;Missing cloud-object-storage parameter.&#39;</span>)

  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">endpoint</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">params</span>[<span style="color:#e6db74">&#39;cos_endpoint&#39;</span>]
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">endpoint</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;Missing cos_endpoint parameter.&#39;</span>)

  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">config</span> <span style="color:#f92672">=</span> {
    <span style="color:#a6e22e">endpoint</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">endpoint</span>,
    <span style="color:#a6e22e">apiKeyId</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">cos_creds</span>.<span style="color:#a6e22e">apikey</span>,
    <span style="color:#a6e22e">serviceInstanceId</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">cos_creds</span>.<span style="color:#a6e22e">resource_instance_id</span>
  }

  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">COS</span>.<span style="color:#a6e22e">S3</span>(<span style="color:#a6e22e">config</span>);
}

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">list</span> (<span style="color:#a6e22e">params</span>) {
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">bucket</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Missing bucket parameter.&#34;</span>)
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">client</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">cos_client</span>(<span style="color:#a6e22e">params</span>)

  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">listObjects</span>({ <span style="color:#a6e22e">Bucket</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">bucket</span> }).<span style="color:#a6e22e">promise</span>()
    .<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">results</span> =&gt; ({ <span style="color:#a6e22e">files</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">results</span>.<span style="color:#a6e22e">Contents</span> }))
}
</code></pre></div><p>This action retrieves the bucket name, service endpoint and authentication credentials from invocation parameters. Errors are returned if those parameters are missing.</p>
<ul>
<li>Create a new package action from this source file with the following command.</li>
</ul>
<pre><code>$ bx wsk action create serverless-files/list-files actions.js --main list --kind nodejs:8
ok: created action list-files
</code></pre><p><em>The <code>‚Äîmain</code> flag set the function name to call for each invocation. This defaults to <code>main</code>. Setting this to an explicit value allows us to use a single source file for multiple actions.</em></p>
<p><em>The <code>‚Äîkind</code> sets the action runtime. This optional flag ensures we use the <a href="https://github.com/ibm-functions/runtime-nodejs">Node.js 8 runtime</a> rather than <a href="https://github.com/apache/incubator-openwhisk-runtime-nodejs/tree/master/core/nodejs6Action">Node.js 6</a>, which is the default for JavaScript actions. The IBM Cloud Object Storage client library is only included in the <a href="https://github.com/ibm-functions/runtime-nodejs">Node.js 8 runtime</a>.</em></p>
<ul>
<li>Invoke the new action to verify it works.</li>
</ul>
<pre><code>$ bx wsk action invoke serverless-files/list-files -r
{
    &quot;files&quot;: [
        { &quot;Key&quot;: &quot;jumping pug.jpg&quot;, ... },
        { &quot;Key&quot;: &quot;pug blanket.jpg&quot;, ... },
        { &quot;Key&quot;: &quot;swimming pug.jpg&quot;, ... }
    ]
}
</code></pre><p>The action response should contain a list of the files uploaded before. üíØüíØüíØ</p>
<h3 id="retrieve-object-contents-from-bucket">Retrieve Object Contents From Bucket</h3>
<p>Let&rsquo;s add another action for retrieving object contents from a bucket.</p>
<ul>
<li>Add a new function (<code>retrieve</code>) to the existing source file (<code>action.js</code>) with the following source code.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">retrieve</span> (<span style="color:#a6e22e">params</span>) {
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">bucket</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Missing bucket parameter.&#34;</span>)
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">name</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Missing name parameter.&#34;</span>)
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">client</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">cos_client</span>(<span style="color:#a6e22e">params</span>)

  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">getObject</span>({ <span style="color:#a6e22e">Bucket</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">bucket</span>, <span style="color:#a6e22e">Key</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">name</span> }).<span style="color:#a6e22e">promise</span>()
    .<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">result</span> =&gt; ({ <span style="color:#a6e22e">body</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">Body</span>.<span style="color:#a6e22e">toString</span>(<span style="color:#e6db74">&#39;base64&#39;</span>) }))
}
</code></pre></div><p>Retrieving files needs a file name in addition to the bucket name. File contents <a href="https://stackoverflow.com/questions/47653181/return-binary-http-response-from-openwhisk-ibm-cloud-function-action">needs encoding as a Base64 string</a> to support returning in the JSON response returned by IBM Cloud Functions.</p>
<ul>
<li>Create an additional action from this updated source file with the following command.</li>
</ul>
<pre><code>$ bx wsk action create serverless-files/retrieve-file actions.js --main retrieve --kind nodejs:8
ok: created action serverless-files/retrieve-file
</code></pre><ul>
<li>Invoke this action to test it works, passing the parameter name for the file to retrieve.</li>
</ul>
<pre><code>$ bx wsk action invoke serverless-files/retrieve-file -r -p name &quot;jumping pug.jpg&quot;
{
    &quot;body&quot;: &quot;&lt;BASE64 ENCODED STRING&gt;&quot;
}
</code></pre><p>If this is successful, a (very long) response body containing a base64 encoded image should be returned. üëç</p>
<h3 id="delete-objects-from-bucket">Delete Objects From Bucket</h3>
<p>Let&rsquo;s finish this section by adding a final action that removes objects from our bucket.</p>
<ul>
<li>Update the source file (<code>actions.js</code>) with this additional function.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">remove</span> (<span style="color:#a6e22e">params</span>) {
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">bucket</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Missing bucket parameter.&#34;</span>)
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">name</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Missing name parameter.&#34;</span>)
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">client</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">cos_client</span>(<span style="color:#a6e22e">params</span>)

  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">deleteObject</span>({ <span style="color:#a6e22e">Bucket</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">bucket</span>, <span style="color:#a6e22e">Key</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">name</span> }).<span style="color:#a6e22e">promise</span>()
}
</code></pre></div><ul>
<li>Create a new action (<code>remove-file</code>) from the updated source file.</li>
</ul>
<pre><code>$ bx wsk action create serverless-files/remove-file actions.js --main remove --kind nodejs:8
ok: created action serverless-files/remove-file
</code></pre><ul>
<li>Test this new action using it to remove a file from the bucket.</li>
</ul>
<pre><code>$ bx wsk action invoke serverless-files/remove-file -r -p name &quot;jumping pug.jpg&quot;
{}
</code></pre><ul>
<li>Listing bucket files should now return two files, rather than three.</li>
</ul>
<pre><code>$ bx wsk action invoke serverless-files/list-files -r
{
    &quot;files&quot;: [
        { &quot;Key&quot;: &quot;pug blanket.jpg&quot;, ... },
        { &quot;Key&quot;: &quot;swimming pug.jpg&quot;, ... }
    ]
}
</code></pre><p>Listing, retrieving and removing files using the client library is relatively simple. Functions just need to call the correct method passing the bucket and object name.</p>
<p><em>Let&rsquo;s move onto a more advanced example, creating new files in the bucket from our action‚Ä¶</em></p>
<h3 id="create-new-objects-within-bucket">Create New Objects Within Bucket</h3>
<p>File content will be passed into our action as Base64 encoded strings. JSON does not support binary data.</p>
<p>When creating new objects, we should <a href="https://docs.aws.amazon.com/AmazonS3/latest/API/RESTCommonRequestHeaders.html">set the MIME type</a>. This is necessary for public access from web browsers, something we&rsquo;ll be doing later on. <a href="https://www.npmjs.com/package/mime-types">Node.js libraries</a> can calculate the correct MIME type value, rather than requiring this as an invocation parameter.</p>
<ul>
<li>Update the source file (<code>action.js</code>) with the following additional code.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">mime</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;mime-types&#39;</span>);

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">upload</span> (<span style="color:#a6e22e">params</span>) {
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">bucket</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Missing bucket parameter.&#34;</span>)
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">name</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Missing name parameter.&#34;</span>)
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">body</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Missing object parameter.&#34;</span>)

  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">client</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">cos_client</span>(<span style="color:#a6e22e">params</span>)
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">body</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Buffer</span>.<span style="color:#a6e22e">from</span>(<span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">body</span>, <span style="color:#e6db74">&#39;base64&#39;</span>)

  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ContentType</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">mime</span>.<span style="color:#a6e22e">contentType</span>(<span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">name</span>) <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39;application/octet-stream&#39;</span>
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">object</span> <span style="color:#f92672">=</span> {
    <span style="color:#a6e22e">Bucket</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">bucket</span>,
    <span style="color:#a6e22e">Key</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">name</span>,
    <span style="color:#a6e22e">Body</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">body</span>,
    <span style="color:#a6e22e">ContentType</span>
  }

  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">upload</span>(<span style="color:#a6e22e">object</span>).<span style="color:#a6e22e">promise</span>()
}

<span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">upload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">upload</span>;
</code></pre></div><p><strong>As this code uses an external NPM library, we need to create the action from a zip file containing source files and external dependencies.</strong></p>
<ul>
<li>Create a <code>package.json</code> file with the following contents.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;upload-files&#34;</span>,
  <span style="color:#f92672">&#34;main&#34;</span>: <span style="color:#e6db74">&#34;actions.js&#34;</span>,
  <span style="color:#f92672">&#34;dependencies&#34;</span>: {
    <span style="color:#f92672">&#34;mime-types&#34;</span>: <span style="color:#e6db74">&#34;^2.1.18&#34;</span>
  }
}
</code></pre></div><ul>
<li>Install external libraries in local environment.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ npm install
added <span style="color:#ae81ff">2</span> packages in 0.804s
</code></pre></div><ul>
<li>Bundle source file and dependencies into zip file.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ zip -r upload.zip package.json actions.js node_modules
  adding: actions.js <span style="color:#f92672">(</span>deflated 72%<span style="color:#f92672">)</span>
  adding: node_modules/ <span style="color:#f92672">(</span>stored 0%<span style="color:#f92672">)</span>
  ...
</code></pre></div><ul>
<li>Create a new action from the zip file.</li>
</ul>
<pre><code>$ bx wsk action create serverless-files/upload-file upload.zip --main upload --kind nodejs:8
ok: created action serverless-files/upload-file
</code></pre><ul>
<li>Create the Base64-encoded string used to pass the new file&rsquo;s content.</li>
</ul>
<pre><code>$ wget http://www.pugnow.com/wp-content/uploads/2016/04/fly-pug-300x300.jpg
$ base64 fly-pug-300x300.jpg &gt; body.txt
</code></pre><ul>
<li>Invoke the action with the file name and content as parameters.</li>
</ul>
<pre><code>$ bx wsk action invoke serverless-files/upload-file -r -p body $(cat body.txt) -p name &quot;flying pug.jpg&quot;
</code></pre><p>Object details should be returned if the file was uploaded correctly.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#f92672">&#34;Bucket&#34;</span>: <span style="color:#e6db74">&#34;my-serverless-files&#34;</span>,
    <span style="color:#f92672">&#34;ETag&#34;</span>: <span style="color:#e6db74">&#34;\&#34;b2ae0fb61dc827c03d6920dfae58e2ba\&#34;&#34;</span>,
    <span style="color:#f92672">&#34;Key&#34;</span>: <span style="color:#e6db74">&#34;flying pug.jpg&#34;</span>,
    <span style="color:#f92672">&#34;Location&#34;</span>: <span style="color:#e6db74">&#34;https://&lt;MY_BUCKET_NAME&gt;.s3-api.us-geo.objectstorage.softlayer.net/flying%20pug.jpg&#34;</span>,
    <span style="color:#f92672">&#34;key&#34;</span>: <span style="color:#e6db74">&#34;flying pug.jpg&#34;</span>
}
</code></pre></div><p>Accessing the <a href="https://console.bluemix.net/objectstorage/">object storage dashboard</a> shows the new object in the bucket, with the correct file name and size.</p>
<p><img src="/images/cos_storage/upload-file-display.png" alt=""></p>
<p><em>Having actions to create, delete and access objects within a bucket, what&rsquo;s left to do?</em> ü§î</p>
<h3 id="expose-public-objects-from-buckets">Expose Public Objects From Buckets</h3>
<p>Users can also choose to make certain <a href="https://console.bluemix.net/docs/services/cloud-object-storage/iam/public-access.html#allowing-public-access">objects within a bucket public</a>. Public objects can be retrieved, using the external HTTP API, without any further authentication.</p>
<p>Public file access allows external clients to access files directly. It removes the need to invoke (and pay for) a serverless function to serve content. This is useful for serving static assets and media files.</p>
<p>Objects have an explicit property (<code>x-amz-acl</code>) which controls access rights. Files default to having this value set as <code>private</code>, meaning all operations require authentication. Setting this value to <code>public-read</code> will enable <code>GET</code> operations without authentication.</p>
<p><em><strong>Files can be created with an explicit ACL property using credentials with the <code>Writer</code> or <code>Manager</code> role. Modifying ACL values for existing files is only supported using credentials with the <code>Manager</code> role.</strong></em></p>
<ul>
<li>Add the following source code to the existing actions file (<code>action.js</code>).</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">make_public</span> (<span style="color:#a6e22e">params</span>) {
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">update_acl</span>(<span style="color:#a6e22e">params</span>, <span style="color:#e6db74">&#39;public-read&#39;</span>)
}

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">make_private</span> (<span style="color:#a6e22e">params</span>) {
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">update_acl</span>(<span style="color:#a6e22e">params</span>, <span style="color:#e6db74">&#39;private&#39;</span>)
}

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">update_acl</span> (<span style="color:#a6e22e">params</span>, <span style="color:#a6e22e">acl</span>) =&gt; {
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">bucket</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Missing bucket parameter.&#34;</span>)
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">name</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Missing name parameter.&#34;</span>)
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">client</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">cos_client</span>(<span style="color:#a6e22e">params</span>)

  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">options</span> <span style="color:#f92672">=</span> {
    <span style="color:#a6e22e">Bucket</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">bucket</span>,
    <span style="color:#a6e22e">Key</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">name</span>,
    <span style="color:#a6e22e">ACL</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">acl</span>
  }

  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">putObjectAcl</span>(<span style="color:#a6e22e">options</span>).<span style="color:#a6e22e">promise</span>()
}
</code></pre></div><ul>
<li>Create two new actions with the update source file.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ bx wsk action create serverless-files/make-public actions.js --main make_public --kind nodejs:8
ok: created action serverless-files/make-public
$ bx wsk action create serverless-files/make-private actions.js --main make_private --kind nodejs:8
ok: created action serverless-files/make-private
</code></pre></div><p><em>Bucket objects use the following URL scheme</em>: <em>https://&lt;BUCKET_NAME&gt;.&lt;ENDPOINT_HOST&gt;/&lt;OBJECT_NAME&gt;</em></p>
<p>We have been using the following endpoint hostname:  <code>s3-api.us-geo.objectstorage.softlayer.net</code>.</p>
<ul>
<li>Checking the status code returned when accessing an existing object confirms it defaults to private.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl -I https://&lt;BUCKET_NAME&gt;.s3-api.us-geo.objectstorage.softlayer.net/flying%20pug.jpg
HTTP/1.1 <span style="color:#ae81ff">403</span> Forbidden
...
</code></pre></div><ul>
<li>Invoke the <code>make-public</code> action to allow GET requests without authentication.</li>
</ul>
<pre><code>$ bx wsk action invoke serverless-files/make-public -r -p name &quot;flying pug.jpg&quot;
</code></pre><ul>
<li>Retry file access using the external HTTP API. This time a <code>200</code> response is returned with the content.</li>
</ul>
<pre><code>$ curl -I https://&lt;BUCKET_NAME&gt;.s3-api.us-geo.objectstorage.softlayer.net/flying%20pug.jpg
HTTP/1.1 200 OK
Content-Type: image/jpeg
...
</code></pre><p>Having set an explicit content type for the file, opening this URL in a web browser will show the image.</p>
<p><img src="http://www.pugnow.com/wp-content/uploads/2016/04/fly-pug-300x300.jpg" alt=""></p>
<ul>
<li>Disable public access using the other new action.</li>
</ul>
<pre><code>bx wsk action invoke serverless-files/make-private -r -p name &quot;flying pug.jpg&quot;
</code></pre><ul>
<li>Re-issue the <code>curl</code> request to the file location.</li>
</ul>
<pre><code>$ curl -I https://&lt;BUCKET_NAME&gt;.s3-api.us-geo.objectstorage.softlayer.net/flying%20pug.jpg
HTTP/1.1 403 Forbidden
...
</code></pre><p>HTTP requests to this file now return a <code>403</code> status. Authentication is required again. üîë</p>
<p><em>In addition to allowing public read access we can go even further in allowing clients to interact with buckets‚Ä¶</em></p>
<h3 id="provide-direct-upload-access-to-buckets">Provide Direct Upload Access To Buckets</h3>
<p>Cloud Object Storage provides a mechanism (<a href="https://console.bluemix.net/docs/services/cloud-object-storage/hmac/presigned-urls.html#create-a-presigned-url"><em>presigned URLs</em></a>) to generate temporary links that allow clients to interact with buckets without further authentication. Passing these links to clients means they can access to private objects or upload new files to buckets. Presigned URLs expire after a configurable time period.</p>
<p><strong>Generating presigned URLs is only supported from <a href="https://console.bluemix.net/docs/services/cloud-object-storage/hmac/credentials.html#using-hmac-credentials">HMAC authentication keys</a>.</strong></p>
<p>HMAC service credentials must be manually provisioned, rather than using the <code>bx wsk service bind</code> command. See above for instructions on how to do this.</p>
<ul>
<li>Save provisioned HMAC keys into a file called <code>credentials.json</code>.</li>
</ul>
<p>Let&rsquo;s create an action that returns presigned URLs, allowing users to upload files directly. Users will call the action with a new file name. Returned URLs will support an unauthenticated PUT request for the next five minutes.</p>
<ul>
<li>Create a new file called <code>presign.js</code></li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#e6db74">&#39;use strict&#39;</span>;

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">COS</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;ibm-cos-sdk&#39;</span>);
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">mime</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;mime-types&#39;</span>);

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">cos_client</span> (<span style="color:#a6e22e">params</span>) {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">creds</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">cos_hmac_keys</span>
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">creds</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;Missing cos_hmac_keys parameter.&#39;</span>)

  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">endpoint</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">cos_endpoint</span>
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">endpoint</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;Missing cos_endpoint parameter.&#39;</span>)

  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">config</span> <span style="color:#f92672">=</span> {
    <span style="color:#a6e22e">endpoint</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">endpoint</span>,
    <span style="color:#a6e22e">accessKeyId</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">creds</span>.<span style="color:#a6e22e">access_key_id</span>, 
    <span style="color:#a6e22e">secretAccessKey</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">creds</span>.<span style="color:#a6e22e">secret_access_key</span>
  }

  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">COS</span>.<span style="color:#a6e22e">S3</span>(<span style="color:#a6e22e">config</span>);
}

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">presign</span> (<span style="color:#a6e22e">params</span>) {
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">bucket</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Missing bucket parameter.&#34;</span>)
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">name</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Missing name parameter.&#34;</span>)

  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">client</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">cos_client</span>(<span style="color:#a6e22e">params</span>)

  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">options</span> <span style="color:#f92672">=</span> {
    <span style="color:#a6e22e">Bucket</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">bucket</span>,
    <span style="color:#a6e22e">Key</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">name</span>,
    <span style="color:#a6e22e">Expires</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">300</span>,
    <span style="color:#a6e22e">ContentType</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">mime</span>.<span style="color:#a6e22e">contentType</span>(<span style="color:#a6e22e">params</span>.<span style="color:#a6e22e">name</span>) <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39;application/octet-stream&#39;</span>
  }

  <span style="color:#66d9ef">return</span> { <span style="color:#a6e22e">url</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">getSignedUrl</span>(<span style="color:#e6db74">&#39;putObject&#39;</span>, <span style="color:#a6e22e">options</span>) }
}

<span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">presign</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">presign</span>;
</code></pre></div><ul>
<li>Update the <code>package.json</code> file with the following contents.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;presign&#34;</span>,
  <span style="color:#f92672">&#34;main&#34;</span>: <span style="color:#e6db74">&#34;presign.js&#34;</span>,
  <span style="color:#f92672">&#34;dependencies&#34;</span>: {
    <span style="color:#f92672">&#34;mime-types&#34;</span>: <span style="color:#e6db74">&#34;^2.1.18&#34;</span>
  }
}
</code></pre></div><ul>
<li>Bundle source file and dependencies into zip file.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ zip -r presign.zip package.json presign.js node_modules
  adding: actions.js <span style="color:#f92672">(</span>deflated 72%<span style="color:#f92672">)</span>
  adding: node_modules/ <span style="color:#f92672">(</span>stored 0%<span style="color:#f92672">)</span>
  ...
</code></pre></div><ul>
<li>Create a new action from the zip file.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ bx wsk action create serverless-files/presign presign.zip --main presign --kind nodejs:8 -P credentials.json
ok: created action serverless-files/presign
</code></pre></div><ul>
<li>Invoke the action to return a presigned URL for a new file.</li>
</ul>
<pre><code>$ bx wsk action invoke serverless-files/presign -r -p name pug.jpg
{
    &quot;url&quot;: &quot;https://&lt;BUCKET&gt;.s3-api.us-geo.objectstorage.softlayer.net/pug.jpg?AWSAccessKeyId=&lt;SECRET&gt;&amp;Content-Type=image%2Fjpeg&amp;Expires=&lt;TIME&gt;&amp;Signature=&lt;KEY&gt;&quot;
}
</code></pre><p>Using this URL we can upload a new image without providing authentication credentials.</p>
<ul>
<li>This curl command <code>‚Äîupload-file</code> will send a HTTP PUT, with image file as request body, to that URL.</li>
</ul>
<pre><code>$ curl --upload-file &quot;my pug.jpg&quot; &lt;URL&gt; --header &quot;Content-Type: image/jpeg&quot;
</code></pre><p><em>The HTTP request must include the correct &ldquo;Content-Type&rdquo; header. Use the value provided when creating the presigned URL. If these values do not match, the request will be rejected.</em></p>
<p>Exploring the objects in our bucket confirms we have uploaded a file! üï∫üíÉ</p>
<p><img src="/images/cos_storage/uploaded-my-pug.png" alt=""></p>
<p>Presigned URLs are a brilliant feature of Cloud Object Storage. Allowing users to upload files directly overcomes the payload limit for cloud functions. It also reduces the cost for uploading files, removing the cloud functions&rsquo; invocation cost.</p>
<h2 id="conclusion">conclusion</h2>
<p>Object storage services are the solution for managing files with serverless applications.</p>
<p>IBM Cloud provides both a serverless runtime (<a href="https://console.bluemix.net/openwhisk/">IBM Cloud Functions</a>) and an object storage service (<a href="https://console.bluemix.net/catalog/services/cloud-object-storage">IBM Cloud Object Store</a>). In this blog post, we looked at how integrate these services to provide a file storage solution for serverless applications.</p>
<p>We showed you how to provision new COS services, create and manage authentication credentials, access files using a client library and even allow external clients to interact directly with buckets. Sample serverless functions using the Node.js runtime were also provided.</p>
<p><em>Do you have any questions, comments or issues about the content above? Please leave a comment below, find me on the <a href="http://openwhisk.incubator.apache.org/slack.html">openwhisk slack</a> or send me a <a href="https://twitter.com/thomasj">tweet</a>.</em></p>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/2018/04/file-storage-for-serverless-applications/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">File Storage For Serverless Applications</span>
    </a>
    
    
    <a href="/2018/06/binding-iam-services-to-ibm-cloud-functions/" class="navigation-next">
      <span class="navigation-tittle">Binding IAM Services To IBM Cloud Functions</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  
    


</article>


        </div>
        
    

<script defer src="https://use.fontawesome.com/releases/v5.11.2/js/all.js" integrity="sha384-b3ua1l97aVGAPEIe48b4TC60WUQbQaGi2jqAWM90y0OZXZeyaTCWtBTKtjW2GXG1" crossorigin="anonymous"></script>
<script data-goatcounter="https://jamesthomas.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>


    
    
    <script type="text/javascript">
        

    </script>
    




    



    </body>
</html>
