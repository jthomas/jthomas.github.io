
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>James Thomas</title>
  <meta name="author" content="James Thomas">

  
  <meta name="description" content="OpenWhisk&#8217;s Python runtime includes popular third-party libraries like requests, scrapy and simplejson. Developers don&#8217;t have to manually &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jthomas.github.com/jthomas/blog/page/2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/JamesThomas" rel="alternate" title="James Thomas" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26491341-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">James Thomas</a></h1>
  
    <h2>Notes on software.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/JamesThomas" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:jthomas.github.com/jthomas" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="http://about.me/j_thomas">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/04/27/python-packages-in-openwhisk/">Python Packages in OpenWhisk</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-04-27T17:15:00+01:00" pubdate data-updated="true">Apr 27<span>th</span>, 2017</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>OpenWhisk&#8217;s Python runtime <a href="https://github.com/openwhisk/openwhisk/blob/master/docs/reference.md#python-actions">includes popular third-party libraries</a> like requests, scrapy and simplejson. Developers don&#8217;t have to manually install packages to use those libraries.</p>

<p><em>Great, but what about using other libraries that aren&#8217;t pre-installed?</em></p>

<p>In a <a href="http://jamesthom.as/blog/2016/11/28/npm-modules-in-openwhisk/">previous blog post</a>, we showed how to deploy Node.js actions from zip files containing third-party modules. These modules are then made available in the Node.js runtime.</p>

<p><strong><a href="https://github.com/openwhisk/openwhisk/pull/1940">Recent updates</a> to OpenWhisk allow us to use the same approach with the Python runtime!</strong></p>

<h2>Python Packages</h2>

<p>Python packages can be installed using the <a href="https://pypi.python.org/pypi/pip">pip tool</a>. This can be used to install individual packages or a series of dependencies from an external file.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pip install blah
</span><span class='line'>$ pip install -r requirements.txt</span></code></pre></td></tr></table></div></figure>


<p>pip defaults to installing packages in a global location (<a href="http://stackoverflow.com/questions/31384639/what-is-pythons-site-packages-directory">site-packages</a>) which is shared between all users. This can cause issues when different projects require different versions of the same package.</p>

<h3>virtualenv</h3>

<p><a href="http://python-guide-pt-br.readthedocs.io/en/latest/dev/virtualenvs/">virtualenv</a> is a tool that solves this issue by creating virtual python environments for projects. The virtual environment includes a custom <code>site-packages</code> folder to install packages into.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ virtualenv env
</span><span class='line'>Using base prefix '/Library/Frameworks/Python.framework/Versions/3.6'
</span><span class='line'>New python executable in /private/tmp/env/bin/python3.6
</span><span class='line'>Also creating executable in /private/tmp/env/bin/python
</span><span class='line'>Installing setuptools, pip, wheel...done.</span></code></pre></td></tr></table></div></figure>


<p>OpenWhisk <a href="https://github.com/openwhisk/openwhisk/pull/1940">recently added support</a> for using virtualenv in the Python runtime.</p>

<h3>custom packages on openwhisk</h3>

<p>OpenWhisk actions can be created from a zip file <a href="https://github.com/openwhisk/openwhisk/blob/master/docs/actions.md#packaging-an-action-as-a-nodejs-module">containing source files and other resources</a>.</p>

<p>If the archive includes a virtual Python environment folder, the platform runs the <code>./bin/activate_this.py</code> script before executing Python actions. This script modifies the module search path to include the local <code>site-packages</code> folder.</p>

<p><em>This will only happen during &#8220;cold&#8221; activations.</em></p>

<p><strong>This feature comes with the following restrictions.</strong></p>

<ul>
<li>Virtual Python environment must be in a folder called <code>virtualenv</code> under the top-level directory.</li>
<li>Packages must be available for the Python runtime being used in OpenWhisk (2.7 or 3.6).</li>
</ul>


<p>Let&#8217;s look at an example of building an OpenWhisk Python action which uses an external Python package.</p>

<h3>Python Package Example</h3>

<p>The <a href="https://pypi.python.org/pypi/pyjokes">pyjokes</a> package provides a library for generating (terrible) jokes for programmers. Let&#8217;s turn this package into an API (Jokes-as-a-Service!) using the Python runtime on OpenWhisk.</p>

<p>Start by creating a new directory for your project and set up the virtual Python environment.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>mkdir jokes; <span class="nb">cd </span>jokes
</span><span class='line'><span class="nv">$ </span>virtualenv virtualenv
</span><span class='line'>Using base prefix <span class="s1">&#39;/Library/Frameworks/Python.framework/Versions/3.6&#39;</span>
</span><span class='line'>New python executable in /tmp/jokes/virtualenv/bin/python3.6
</span><span class='line'>Also creating executable in /tmp/jokes/virtualenv/bin/python
</span><span class='line'>Installing setuptools, pip, wheel...done.
</span><span class='line'><span class="nv">$ </span><span class="nb">source </span>virtualenv/bin/activate
</span><span class='line'><span class="o">(</span>virtualenv<span class="o">)</span> <span class="nv">$ </span>pip install pyjokes
</span><span class='line'>Collecting pyjokes
</span><span class='line'>  Using cached pyjokes-0.5.0-py2.py3-none-any.whl
</span><span class='line'>Installing collected packages: pyjokes
</span><span class='line'>Successfully installed pyjokes-0.5.0
</span><span class='line'><span class="o">(</span>virtualenv<span class="o">)</span> <span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the project directory, create a new file (<code>__main__.py</code>) and paste the following code.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">pyjokes</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">joke</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">{</span><span class="s">&quot;joke&quot;</span><span class="p">:</span> <span class="n">pyjokes</span><span class="o">.</span><span class="n">get_joke</span><span class="p">()}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Check the script works with the Python intepreter.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">(</span>virtualenv<span class="o">)</span> <span class="nv">$ </span>python -i .
</span><span class='line'>&gt;&gt;&gt; joke<span class="o">({})</span>
</span><span class='line'><span class="o">{</span><span class="s1">&#39;joke&#39;</span>: <span class="s1">&#39;What do you call a programmer from Finland? Nerdic.&#39;</span><span class="o">}</span>
</span><span class='line'>&gt;&gt;&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Add the <code>virtualenv</code> folder and Python script to a new zip file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>zip -r jokes.zip virtualenv __main__.py
</span><span class='line'>  adding: virtualenv/ <span class="o">(</span>stored 0%<span class="o">)</span>
</span><span class='line'>  adding: virtualenv/.Python <span class="o">(</span>deflated 65%<span class="o">)</span>
</span><span class='line'>  adding: virtualenv/bin/ <span class="o">(</span>stored 0%<span class="o">)</span>
</span><span class='line'>  adding: virtualenv/bin/activate <span class="o">(</span>deflated 63%<span class="o">)</span>
</span><span class='line'>  ...
</span><span class='line'><span class="nv">$ </span>ls
</span><span class='line'>__main__.py  jokes.zip   virtualenv
</span></code></pre></td></tr></table></div></figure>


<p>Create a new OpenWhisk action for the Python runtime using the <code>wsk</code> cli.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>wsk action create jokes --kind python:3 --main joke jokes.zip
</span><span class='line'>ok: created action jokes
</span></code></pre></td></tr></table></div></figure>


<p>Invoking our new action will return (bad) jokes on-demand using the third-party Python package.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>wsk action invoke jokes --blocking --result
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;joke&quot;</span>: <span class="s2">&quot;Software salesmen and used-car salesmen differ in that the latter know when they are lying.&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Installing Packages With Docker</h3>

<p>In the example above, the Python runtime used in development (v3.6) matched the OpenWhisk runtime environment. Packages installed using <code>virtualenv</code> must be for the same major and minor versions of the Python runtime used by OpenWhisk.</p>

<p>OpenWhisk publishes the runtime environments as <a href="https://hub.docker.com/u/openwhisk/">Docker images on Docker Hub</a>.</p>

<p>Running containers from <a href="https://hub.docker.com/r/openwhisk/python3action/">those runtime images</a> provides a way to download packages for the correct environment.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker run --rm -v <span class="s2">&quot;$PWD:/tmp&quot;</span> openwhisk/python3action sh <span class="se">\</span>
</span><span class='line'>  -c <span class="s2">&quot;cd tmp; virtualenv virtualenv; source virtualenv/bin/activate; pip install pyjokes;&quot;</span>
</span><span class='line'>Using base prefix <span class="s1">&#39;/usr/local&#39;</span>
</span><span class='line'>New python executable in /tmp/virtualenv/bin/python3.6
</span><span class='line'>Also creating executable in /tmp/virtualenv/bin/python
</span><span class='line'>Installing setuptools, pip, wheel...done.
</span><span class='line'>Collecting pyjokes
</span><span class='line'>  Downloading pyjokes-0.5.0-py2.py3-none-any.whl
</span><span class='line'>Installing collected packages: pyjokes
</span><span class='line'>Successfully installed pyjokes-0.5.0
</span><span class='line'><span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will leave you a <code>virtualenv</code> folder in the current directory with packages for the correct Python runtime.</p>

<h3>Speeding Up Deployments</h3>

<p>Peeking inside the <code>virtualenv</code> folder reveals a huge number of files to set up the virtual Python environment. If we just want to use a third-party package from the local <code>site-packages</code> folder, most of those files are unnecessary.</p>

<p><em>Adding this entire folder to the zip archive will unnecessarily inflate the file size. This will slow down deployments and increase execution time for cold activations. OpenWhisk also has a maximum size for action source code of 48MB.</em></p>

<p>Manually including individual <code>site-packages</code> folders, rather than the entire <code>virtualenv</code> directory, will ensure the archive file only contains packages being used. We must also add the Python script (<code>virtualenv/bin/activate_this.py</code>) executed by OpenWhisk to modify the module search path.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>zip -r jokes_small.zip virtualenv/bin/activate_this.py virtualenv/lib/python3.6/site-packages/pyjokes __main__.py
</span><span class='line'>updating: virtualenv/bin/activate_this.py <span class="o">(</span>deflated 54%<span class="o">)</span>
</span><span class='line'>updating: virtualenv/lib/python3.6/site-packages/pyjokes/ <span class="o">(</span>stored 0%<span class="o">)</span>
</span><span class='line'>updating: virtualenv/lib/python3.6/site-packages/pyjokes/__init__.py <span class="o">(</span>deflated 20%<span class="o">)</span>
</span><span class='line'>updating: virtualenv/lib/python3.6/site-packages/pyjokes/jokes_de.py <span class="o">(</span>deflated 29%<span class="o">)</span>
</span><span class='line'>updating: virtualenv/lib/python3.6/site-packages/pyjokes/jokes_en.py <span class="o">(</span>deflated 61%<span class="o">)</span>
</span><span class='line'>updating: virtualenv/lib/python3.6/site-packages/pyjokes/jokes_es.py <span class="o">(</span>deflated 40%<span class="o">)</span>
</span><span class='line'>updating: virtualenv/lib/python3.6/site-packages/pyjokes/pyjokes.py <span class="o">(</span>deflated 68%<span class="o">)</span>
</span><span class='line'>updating: __main__.py <span class="o">(</span>deflated 18%<span class="o">)</span>
</span><span class='line'><span class="nv">$ </span>ls -lh
</span><span class='line'>total 40984
</span><span class='line'>-rw-r--r--  1 james  wheel    74B 21 Apr 11:01 __main__.py
</span><span class='line'>-rw-r--r--  1 james  wheel    20M 21 Apr 11:07 jokes.zip
</span><span class='line'>-rw-r--r--  1 james  wheel   9.3K 21 Apr 13:36 jokes_small.zip
</span><span class='line'>drwxr-xr-x  6 james  wheel   204B 21 Apr 11:25 virtualenv
</span></code></pre></td></tr></table></div></figure>


<p>The archive file is now less than ten kilobytes! üèÉ</p>

<h4>With The Serverless Framework</h4>

<p><a href="https://serverless.com/">The Serverless Framework</a> is a popular open-source framework for building serverless applications. This framework handles the configuration, packaging and deployment of your serverless application.</p>

<p>OpenWhisk is supported through a <a href="https://www.npmjs.com/package/serverless-openwhisk">provider plugin</a>. <a href="https://medium.com/openwhisk/serverless-framework-and-openwhisk-plugin-update-v0-6-1339cfdcd2d2">Recent versions</a> of the plugin added support for the Python runtime environment.</p>

<p>Using the <a href="https://serverless.com/framework/docs/providers/openwhisk/guide/serverless.yml/">application configuration file</a> for the framework, users can add <code>include</code> and <code>exclude</code> parameters to control the contents of the archive file before deployment.</p>

<p>Here&#8217;s an example of the configuration needed to only include the necessary files for the application above.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pyjokes</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">provider</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">openwhisk</span>
</span><span class='line'>  <span class="l-Scalar-Plain">runtime</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">python:3</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">functions</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">jokes</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">handler</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">handler.joke</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">plugins</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">serverless-openwhisk</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">package</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">exclude</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">virtualenv/**</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="s">&#39;!virtualenv/bin/activate_this.py&#39;</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="s">&#39;!virtualenv/lib/python3.6/site-packages/pyjokes/**&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>conclusion</h3>

<p>Python has a huge community of third-party packages for everything from parsing JSON, making HTTP requests and even generating jokes. OpenWhisk already provided a number of the most popular packages within the Python runtime.</p>

<p>Users can install additional packages locally using the <code>pip</code> and <code>virtualenv</code> tools. Bundling those files within the deployment archive means they are extracted into the OpenWhisk Python runtime environment.</p>

<p>Recent changes to the Python runtime allows the platform to automatically add local package folders to the module search path.</p>

<p><strong>This means Python functions running on OpenWhisk can now use any third-party library as if it was installed globally.</strong></p>

<p>Hurrah üëå!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/03/20/smsbot/">Building an SMS Bot for Slack.</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-03-20T16:02:00+00:00" pubdate data-updated="true">Mar 20<span>th</span>, 2017</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is <a href="https://github.com/ibmets/smsbot">smsbot</a>.</p>

<p><img src="/images/smsbot/slack_text_hidden.jpg"></p>

<p>It provides an integration with Slack that connects SMS messages into channels. People can text an external number and have their messages posted into the channel. Channel users can respond to the messages and have their response sent back to the sender using SMS.</p>

<blockquote><p>smsbot was developed in under a few hours and less than one hundred lines of code using a serverless cloud platform.</p></blockquote>


<p>Want to understand how it works? Let&#8217;s find out‚Ä¶</p>

<p>The first challenge was how to programmatically send and receive SMS messages.</p>

<p><em><strong>Want to deploy smsbot yourself? Follow the <a href="#Deployment">instructions</a> at the bottom or check out the <a href="https://github.com/ibmets/smsbot">Github repository</a>.</strong></em></p>

<h2>Twilio</h2>

<p><img src="http://www.timothylutts.com/wp-content/uploads/2016/09/twilio.jpg"></p>

<p><a href="https://twilio.com">Twilio</a> provides a platform for building SMS, voice and messaging applications using an API.</p>

<p>Developers can <a href="https://www.twilio.com/console/phone-numbers">register phone numbers</a> through the service that invoke webhooks for incoming calls and SMS messages. Webhooks are passed message details and return a custom markup language (TwilML) to encode the instructions on how to respond to the request.</p>

<p>The platform also provides a REST API to <a href="https://www.twilio.com/sms/api">initiate phone calls and SMS messages</a>.</p>

<p><em>We now have a way to handle text messages for our bot, how do we integrate a new bot in Slack?</em></p>

<h2>Slack</h2>

<p><img src="http://stratejos.ai/img/logos/slack-logo.png"></p>

<p><a href="https://slack.com">Slack</a> also provides a webhook-based mechanism to integrate custom bots into the platform. The platform has two different integrations‚Ä¶</p>

<h3>Incoming Webhooks.</h3>

<p>Provide a way to post messages into Slack from external sources. It provides a custom URL that supports HTTP requests with a JSON payload. These requests are turned into channel messages. The JSON payload is used to control the content and formatting of the message.</p>

<p><a href="https://api.slack.com/incoming-webhooks">https://api.slack.com/incoming-webhooks</a></p>

<h3>Outgoing Webhooks</h3>

<p>Allow you to listen for messages in channels without using the full real-time API. Slack sends HTTP requests to registered URLs when specific trigger words appear in channel messages. The HTTP request body contains the message details.</p>

<p><a href="https://api.slack.com/outgoing-webhooks">https://api.slack.com/outgoing-webhooks</a></p>

<p><em>Now we just need a way to write simple HTTP services to listen for webhook requests‚Ä¶</em></p>

<h2>OpenWhisk</h2>

<p><img src="http://openwhisk.org/images/apache-openwhisk.jpg"></p>

<p><a href="http://openwhisk.org">OpenWhisk</a> is an open-source serverless cloud platform. <a href="https://martinfowler.com/articles/serverless.html">Serverless platforms</a> make it easy to create microservices in the cloud without having to set up or manage any infrastructure.</p>

<p>Developers push their code directly into the platform. The platform will instantiate the runtime and invoke the code on-demand for each request. Serverless functions can be <a href="https://github.com/openwhisk/openwhisk/blob/master/docs/apigateway.md">exposed as HTTP endpoints</a> or connected to <a href="https://github.com/openwhisk/openwhisk/blob/master/docs/catalog.md">event sources</a> like <a href="https://github.com/openwhisk/openwhisk-package-kafka/blob/master/README.md">message queues</a> or <a href="https://github.com/openwhisk/openwhisk-package-cloudant/blob/master/README.md">databases</a>.</p>

<p>Serverless platforms make it easy to create simple HTTP services to handle webhook requests.</p>

<h3>Web Actions</h3>

<p><a href="https://medium.com/openwhisk/serverless-http-handlers-with-openwhisk-90a986cc7cdd#.rki6bwjgu">Web Actions</a> are a new feature in OpenWhisk for exposing serverless functions as simple HTTP endpoints. Functions have access to the full HTTP request and can control the HTTP response returned. This method is suitable for simple public endpoints that do not need more enterprise features supported by the <a href="https://github.com/openwhisk/openwhisk/blob/master/docs/apigateway.md">API gateway</a>.</p>

<p>Web Actions are available at the following <a href="https://github.com/openwhisk/openwhisk/blob/master/docs/webactions.md">platform API path</a>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>https://{APIHOST}/api/v1/experimental/web/{USER_NAMESPACE}/{PACKAGE}/{ACTION_NAME}.{TYPE}</span></code></pre></td></tr></table></div></figure>


<ul>
<li><em>APIHOST</em> - platform endpoint e.g. <em>openwhisk.ng.bluemix.net.</em></li>
<li><em>USER_NAMESPACE</em> - must be explicit and cannot use the default namespace (_).</li>
<li><em>PACKAGE</em> - action package or <code>default</code>.</li>
<li><em>ACTION_NAME</em> - function identifier.</li>
<li><em>TYPE</em> - <code>.json</code>, <code>.html</code>, <code>.text</code> or <code>.http</code>.</li>
</ul>


<h3>Example</h3>

<p>Here&#8217;s a simple Web Actions that returns HTML content when invoked through the API.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">main</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;you didn&amp;#39;t tell me who you are.&quot;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">msg</span> <span class="o">=</span> <span class="err">`</span><span class="nx">hello</span> <span class="nx">$</span><span class="p">{</span><span class="nx">args</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="o">!</span><span class="err">`</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">{</span><span class="nx">body</span><span class="o">:</span>
</span><span class='line'>       <span class="err">`</span><span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;&lt;</span><span class="nx">body</span><span class="o">&gt;&lt;</span><span class="nx">h3</span><span class="o">&gt;&lt;</span><span class="nx">center</span><span class="o">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">msg</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/center&gt;&lt;/h3&gt;&lt;/body&gt;&lt;/html&gt;`}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Actions can be turned into web-accessible actions by setting a custom annotation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span> <span class="nx">wsk</span> <span class="nx">action</span> <span class="nx">create</span> <span class="nx">greeting</span> <span class="nx">source</span><span class="p">.</span><span class="nx">js</span> <span class="o">--</span><span class="nx">annotation</span> <span class="nx">web</span><span class="o">-</span><span class="kr">export</span> <span class="kc">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>greeting</code> function can then be invoked through a HTTP request to the following endpoint.</p>

<p><code>https://openwhisk.ng.bluemix.net/api/v1/experimental/web/user@host.com_dev/default/greeting.http?name=James</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>http post https://openwhisk.ng.bluemix.net/api/v1/experimental/web/user@host.com_dev/default/html_greeting.http?name<span class="o">=</span>James
</span><span class='line'>HTTP/1.1 200 OK
</span><span class='line'>...
</span><span class='line'>
</span><span class='line'>&lt;html&gt;&lt;body&gt;&lt;h3&gt;&lt;center&gt;hello James!&lt;/center&gt;&lt;/h3&gt;&lt;/body&gt;&lt;/html&gt;
</span></code></pre></td></tr></table></div></figure>


<h2>Twilio &lt;=> Slack</h2>

<p>OpenWhisk Web Actions are a great solution for creating webhook endpoints. Connecting Twilio to Slack (and vice-versa) can be implemented using two different OpenWhisk Web Actions.</p>

<ul>
<li><strong>Twilio Webhook.</strong> Invoked for SMS messages. Uses the Slack Incoming Webhook to create a bot messages from content.
‚Äã</li>
<li><strong>Slack Outgoing Webhook.</strong> Invoked for channel replies. Uses Twilio API to send replies as SMS messages.</li>
</ul>


<p>Let&#8217;s have a look at the Twilio webhook first‚Ä¶</p>

<h3>Twilio Webhook</h3>

<p>When a new SMS message is received, we want to post this bot message into our Slack channel.</p>

<p>Twilio allows developers to <a href="https://www.twilio.com/docs/api/twiml/sms/twilio_request">configure webhooks</a> for each registered phone number. The webhook endpoint will be invoked for each SMS message that is received. Twilio can either send a HTTP POST request, with parameters in the body, or a HTTP GET request, with URL query parameters.</p>

<p>OpenWhisk Web Actions support both formats. Request parameters will be available as <a href="https://github.com/openwhisk/openwhisk/blob/master/docs/webactions.md#http-context">properties on the function argument</a>.</p>

<p>Here&#8217;s a simple Web Action that would log the message sender and content for each SMS received.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">main</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Text</span> <span class="nx">message</span> <span class="nx">from</span> <span class="nx">$</span><span class="p">{</span><span class="nx">params</span><span class="p">.</span><span class="nx">From</span><span class="p">}</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">params</span><span class="p">.</span><span class="nx">Body</span><span class="p">}</span><span class="err">`</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Creating Bot Messages From SMS</h4>

<p>When an SMS message is received, we need to send a HTTP POST to the <a href="https://api.slack.com/incoming-webhooks">Incoming Webhook URL</a>. The JSON body of the HTTP request is used to configure the channel message. Using the <code>username</code>, <code>icon_emoji</code> and and <code>text</code> properties allows us to customise our bot message.</p>

<p>OpenWhisk Actions in Node.js have <a href="https://github.com/openwhisk/openwhisk/blob/master/docs/reference.md#javascript-runtime-environments">numerous popular NPM modules</a> pre-installed in the environment. This includes a <a href="https://github.com/request/request">HTTP client library</a>. This code snippet demonstrates sending the HTTP request to create out bot message. The Slack Webhook URL is bound as a <a href="https://github.com/openwhisk/openwhisk/blob/master/docs/actions.md#setting-default-parameters">default parameter</a> to the action.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">slack_message</span> <span class="o">=</span> <span class="nx">text</span> <span class="o">=&gt;</span> <span class="p">({</span>
</span><span class='line'>  <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;smsbot&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">icon_emoji</span><span class="o">:</span> <span class="s1">&#39;:phone:&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">text</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">main</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">request</span><span class="p">.</span><span class="nx">post</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">body</span><span class="o">:</span> <span class="nx">slack_message</span><span class="p">(</span><span class="err">`</span><span class="nx">Text</span> <span class="nx">message</span> <span class="nx">from</span> <span class="nx">$</span><span class="p">{</span><span class="nx">params</span><span class="p">.</span><span class="nx">From</span><span class="p">}</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">params</span><span class="p">.</span><span class="nx">Body</span><span class="p">}</span><span class="err">`</span><span class="p">),</span>
</span><span class='line'>      <span class="nx">json</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">url</span><span class="o">:</span> <span class="nx">params</span><span class="p">.</span><span class="nx">slack</span><span class="p">.</span><span class="nx">webhook</span>
</span><span class='line'>    <span class="p">},</span> <span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">resolve</span><span class="p">();</span>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Returning a Promise ensures the request is completed before the function exits.</p>

<h4>Sending Acknowledgement Message</h4>

<p>Returning <a href="https://www.twilio.com/docs/api/twiml">TwilML</a> content allows us to control the response from Twilio to the incoming message.</p>

<p>This snippet would send an SMS reply to sender with the content &#8220;Hello World!&#8221;.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;Response&gt;</span>
</span><span class='line'>  <span class="nt">&lt;Message&gt;</span>Hello World!<span class="nt">&lt;/Message&gt;</span>
</span><span class='line'><span class="nt">&lt;/Response&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="https://www.npmjs.com/package/twilio">Twilio&#8217;s client library</a> for Node.js can be used to programatically generate TwilML.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">twilio</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;twilio&#39;</span><span class="p">)</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">resp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">twilio</span><span class="p">.</span><span class="nx">TwimlResponse</span><span class="p">()</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">twilml</span> <span class="o">=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="s1">&#39;Thanks for letting us know.&#39;</span><span class="p">).</span><span class="nx">toString</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Returning XML content as the HTTP response requires us to set the response headers, body and status code in the Web Action.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">main</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">xml</span> <span class="o">=</span> <span class="s1">&#39;...&#39;</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/xml&#39;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nx">code</span><span class="o">:</span> <span class="mi">200</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">body</span><span class="o">:</span> <span class="nx">xml</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Web Action Source</h4>

<p>Adding the XML response code into the existing function completes the OpenWhisk Web Action required to handle incoming SMS messages.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">)</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">twilio</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;twilio&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">resp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">twilio</span><span class="p">.</span><span class="nx">TwimlResponse</span><span class="p">()</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">twilml</span> <span class="o">=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="s1">&#39;Thanks for letting us know.&#39;</span><span class="p">).</span><span class="nx">toString</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/xml&#39;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">code</span><span class="o">:</span> <span class="mi">200</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">body</span><span class="o">:</span> <span class="nx">twilml</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">slack_message</span> <span class="o">=</span> <span class="nx">text</span> <span class="o">=&gt;</span> <span class="p">({</span>
</span><span class='line'>  <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;smsbot&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">icon_emoji</span><span class="o">:</span> <span class="s1">&#39;:phone:&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">text</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">main</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">request</span><span class="p">.</span><span class="nx">post</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">body</span><span class="o">:</span> <span class="nx">slack_message</span><span class="p">(</span><span class="err">`</span><span class="nx">Text</span> <span class="nx">message</span> <span class="nx">from</span> <span class="nx">$</span><span class="p">{</span><span class="nx">params</span><span class="p">.</span><span class="nx">From</span><span class="p">}</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">params</span><span class="p">.</span><span class="nx">Body</span><span class="p">}</span><span class="err">`</span><span class="p">),</span>
</span><span class='line'>      <span class="nx">json</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">url</span><span class="o">:</span> <span class="nx">params</span><span class="p">.</span><span class="nx">slack</span><span class="p">.</span><span class="nx">webhook</span>
</span><span class='line'>    <span class="p">},</span> <span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">resolve</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Register Webhook</h4>

<p>Once we have deployed the Web Action, we can configure the Twilio SMS webhook endpoint to use following URL.</p>

<p><code>https://openwhisk.ng.bluemix.net/api/v1/experimental/web/user@email.com_dev/default/smsbot-dev-incoming.http</code></p>

<p><img src="/images/smsbot/twilio_sms_webhook.png"></p>

<h3>Slack Outgoing Webhook</h3>

<p>When someone sends a channel message to the bot, smsbot should send that content as an SMS message to the last person who sent an SMS to the channel. An <a href="https://api.slack.com/custom-integrations/outgoing-webhooks">Outgoing Webhook</a> will be used to trigger the bot.</p>

<p>Outgoing Webhooks have a configurable trigger word. Channel messages which start with this word are send as HTTP requests to the list of URLs registered for that webhook. We will use <code>smsbot</code> as our trigger word.</p>

<p><img src="/images/smsbot/outgoing_webhook_trigger.png"></p>

<h4>Request Parameters</h4>

<p>Slack sends the following parameters for each channel message.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">token</span><span class="o">=</span><span class="nx">XXXXXXXXXXXXXXXXXX</span>
</span><span class='line'><span class="nx">team_id</span><span class="o">=</span><span class="nx">T0001</span>
</span><span class='line'><span class="nx">team_domain</span><span class="o">=</span><span class="nx">example</span>
</span><span class='line'><span class="nx">channel_id</span><span class="o">=</span><span class="nx">C2147483705</span>
</span><span class='line'><span class="nx">channel_name</span><span class="o">=</span><span class="nx">test</span>
</span><span class='line'><span class="nx">timestamp</span><span class="o">=</span><span class="mf">1355517523.000005</span>
</span><span class='line'><span class="nx">user_id</span><span class="o">=</span><span class="nx">U2147483697</span>
</span><span class='line'><span class="nx">user_name</span><span class="o">=</span><span class="nx">Steve</span>
</span><span class='line'><span class="nx">text</span><span class="o">=</span><span class="nx">googlebot</span><span class="o">:</span> <span class="nx">What</span> <span class="nx">is</span> <span class="nx">the</span> <span class="nx">air</span><span class="o">-</span><span class="nx">speed</span> <span class="nx">velocity</span> <span class="nx">of</span> <span class="nx">an</span> <span class="nx">unladen</span> <span class="nx">swallow</span><span class="o">?</span>
</span><span class='line'><span class="nx">trigger_word</span><span class="o">=</span><span class="nx">googlebot</span><span class="o">:</span>
</span></code></pre></td></tr></table></div></figure>


<p>In OpenWhisk Web Actions, these parameters will be available on the function argument object.</p>

<p>Here&#8217;s a simple Web Action that would parse and log the message contents when the webhook is fired.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">main</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">trigger_word</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;channel message:&#39;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>When this webhook is fired, we need to add code to send an SMS message with the channel message.</p>

<h4>Sending SMS Messages</h4>

<p><a href="https://www.twilio.com/docs/api/rest">Twilio&#8217;s API</a> allows us to programatically <a href="https://www.twilio.com/docs/api/rest/sending-messages">send SMS messages</a> from our registered numbers.</p>

<p>This snippet shows you how to use their <a href="http://npmjs.com/package/twilio">Node.js client library</a> to send sample message.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">twilio</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;twilio&#39;</span><span class="p">)</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">creds</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">account</span><span class="o">:</span> <span class="s1">&#39;...&#39;</span><span class="p">,</span> <span class="nx">auth</span><span class="o">:</span> <span class="s1">&#39;...&#39;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">twilio</span><span class="p">(</span><span class="nx">creds</span><span class="p">.</span><span class="nx">account</span><span class="p">,</span> <span class="nx">creds</span><span class="p">.</span><span class="nx">auth</span><span class="p">)</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">callback</span> <span class="o">=</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;sent sms message.&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">client</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span> <span class="nx">to</span><span class="o">:</span> <span class="s1">&#39;...&#39;</span><span class="p">,</span> <span class="nx">from</span><span class="o">:</span> <span class="s1">&#39;...&#39;</span><span class="p">,</span> <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;hello world&#39;</span> <span class="p">},</span> <span class="nx">callback</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The webhook should use this client library to send a message to the last person who send us an incoming message.</p>

<h4>Reply to Message Sender</h4>

<p>How can we determine who was the last person who sent a message to our bot? The Web Action processing the incoming messages is a separate service to the Web Action sending SMS messages.</p>

<p>Rather than setting up a database to share application state, the service can use Twilio&#8217;s API to retrieve the received message details.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">twilio</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;twilio&#39;</span><span class="p">)</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">creds</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">account</span><span class="o">:</span> <span class="s1">&#39;...&#39;</span><span class="p">,</span> <span class="nx">auth</span><span class="o">:</span> <span class="s1">&#39;...&#39;</span> <span class="p">}</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">twilio</span><span class="p">(</span><span class="nx">creds</span><span class="p">.</span><span class="nx">account</span><span class="p">,</span> <span class="nx">creds</span><span class="p">.</span><span class="nx">auth</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nx">client</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">list</span><span class="p">({</span><span class="nx">to</span><span class="o">:</span> <span class="s1">&#39;+44....&#39;</span><span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">last</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">last</span> <span class="nx">message</span> <span class="nx">from</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">last</span><span class="p">.</span><span class="nx">from</span><span class="p">}</span><span class="err">`</span><span class="p">)</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<h4>SMSBot Channel Response</h4>

<p><a href="https://api.slack.com/custom-integrations/outgoing-webhooks">Outgoing Webhooks</a> which respond with a JSON body will generate a new channel message.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;smsbot&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;icon_emoji&quot;</span><span class="p">:</span> <span class="s2">&quot;:phone:&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;sms sent to ...&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Web Action Source</h4>

<p>Combing the channel message parsing code with the snippets for sending SMS messages and obtaining the last message sender completes the Web Action needed to handle the Outgoing Webhook.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">twilio</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;twilio&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">slack_message</span> <span class="o">=</span> <span class="nx">text</span> <span class="o">=&gt;</span> <span class="p">({</span>
</span><span class='line'>  <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;smsbot&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">icon_emoji</span><span class="o">:</span> <span class="s1">&#39;:phone:&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">text</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">reply</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">twilio</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">twilio</span><span class="p">.</span><span class="nx">account</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">twilio</span><span class="p">.</span><span class="nx">auth</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">client</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">list</span><span class="p">({</span><span class="nx">to</span><span class="o">:</span> <span class="nx">params</span><span class="p">.</span><span class="nx">twilio</span><span class="p">.</span><span class="nx">number</span><span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">last</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">trigger_word</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">last</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">from</span><span class="o">:</span> <span class="nx">last</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span> <span class="nx">body</span><span class="o">:</span> <span class="nx">msg</span> <span class="p">}</span>
</span><span class='line'>    <span class="nx">client</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>        <span class="nx">resolve</span><span class="p">(</span><span class="nx">slack_message</span><span class="p">(</span><span class="err">`</span><span class="nx">sms</span> <span class="nx">reply</span> <span class="nx">sent</span> <span class="nx">to</span> <span class="nx">$</span><span class="p">{</span><span class="nx">last</span><span class="p">.</span><span class="nx">from</span><span class="p">}</span><span class="err">`</span><span class="p">))</span>
</span><span class='line'>      <span class="p">})</span>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Twilio account credentials are bound as <a href="https://github.com/openwhisk/openwhisk/blob/master/docs/actions.md#setting-default-parameters">default parameters</a> to the Web Action during deployment.</p>

<h2>Deployment</h2>

<p><a href="https://github.com/ibmets/smsbot">smsbot</a> is built using <a href="https://serverless.com/">The Serverless Framework</a>.</p>

<p><img src="https://cloud.githubusercontent.com/assets/20538501/24154626/b86ad64a-0e1f-11e7-8e12-979b8d194430.png"></p>

<p>This framework makes building serverless applications really easy. The tool handles the entire configuration and deployment process for your serverless provider. OpenWhisk <a href="https://serverless.com/blog/openwhisk-integration-with-serverless/">recently released integration</a> with the framework through a provider plugin.</p>

<p><strong><em>Let&#8217;s look at how to use the framework to deploy our serverless application‚Ä¶</em></strong></p>

<h3>OpenWhisk</h3>

<p>Register for an account with an OpenWhisk provider, e.g. <a href="https://console.ng.bluemix.net/">IBM Bluemix</a>.</p>

<p><a href="https://console.ng.bluemix.net/openwhisk/learn/cli">Set up</a> the <code>wsk</code> CLI and run the command to authenticate against the platform endpoint.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">wsk</span> <span class="nx">property</span> <span class="nx">set</span> <span class="o">--</span><span class="nx">apihost</span> <span class="nx">openwhisk</span><span class="p">.</span><span class="nx">ng</span><span class="p">.</span><span class="nx">bluemix</span><span class="p">.</span><span class="nx">net</span> <span class="o">--</span><span class="nx">auth</span> <span class="nx">SECRET</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Serverless Framework</h3>

<p>Install the <a href="https://github.com/serverless/serverless">The Serverless Framework</a> and the <a href="https://github.com/serverless/serverless-openwhisk">OpenWhisk provider plugin</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">npm</span> <span class="nx">install</span> <span class="o">--</span><span class="nx">global</span> <span class="nx">serverless</span> <span class="nx">serverless</span><span class="o">-</span><span class="nx">openwhisk</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Source Code</h3>

<p>Download the <a href="https://github.com/jthomas/smsbot">source code</a> from Github and install the project dependencies.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span> <span class="nx">git</span> <span class="nx">clone</span> <span class="nx">https</span><span class="o">:</span><span class="c1">//github.com/ibmets/smsbot.git</span>
</span><span class='line'><span class="nx">$</span> <span class="nx">cd</span> <span class="nx">smsbot</span>
</span><span class='line'><span class="nx">$</span> <span class="nx">npm</span> <span class="nx">install</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create a new file called <code>credentials.yml</code> with the following content.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">twilio</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">account</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">auth</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">number</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">numbers</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">slack</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">webhook</span><span class="p-Indicator">:</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Twilio</h3>

<p>Register an account with Twilio and provision <a href="https://www.twilio.com/console/phone-numbers/search">a new phone number</a>. Make a note of the phone number. Retrieve the account identifier and auth token from the <a href="https://www.twilio.com/console">Twilio console</a>.</p>

<p>Fill in the account identifier, auth token and phone number in the <code>credentials.yml</code> file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">twilio</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">account</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">AC_USER_ID</span>
</span><span class='line'>    <span class="l-Scalar-Plain">auth</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">AUTH_TOKEN</span>
</span><span class='line'>    <span class="l-Scalar-Plain">number</span><span class="p-Indicator">:</span> <span class="s">&#39;+441234567890&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Important: the <code>twilio.number</code> property value must be a quoted string.</em></p>

<h3>Phone Numbers</h3>

<p>During Twilio&#8217;s free trial, you will need <a href="https://support.twilio.com/hc/en-us/articles/223136107-How-does-Twilio-s-Free-Trial-work-">manually verify each phone number</a> that you want to send messages to.</p>

<p>Fill in all verified numbers in <code>credentials.yml</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">numbers</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="s">&#39;+441234567890&#39;</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Joe Smith</span>
</span><span class='line'>    <span class="s">&#39;+441234567891&#39;</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Jane Smith</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Important: the <code>numbers</code> property values must be a quoted strings.</em></p>

<h3>Incoming Webhook</h3>

<p>Create a new <a href="https://api.slack.com/incoming-webhooks">Incoming Webhook</a> integration for the Slack channel messages should appear in.</p>

<p>Fill in the <code>slack.webhook</code> property in <code>credentials.yml</code> with this url.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">slack</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">webhook</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://hooks.slack.com/services/XXXX/YYYY/ZZZZ</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Deploy Application</h3>

<p>Use The Serverless Framework to deploy your application.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ serverless deploy</span>
</span><span class='line'><span class="l-Scalar-Plain">Serverless</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Packaging service...</span>
</span><span class='line'><span class="l-Scalar-Plain">Serverless</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Compiling Functions...</span>
</span><span class='line'><span class="l-Scalar-Plain">Serverless</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Compiling API Gateway definitions...</span>
</span><span class='line'><span class="l-Scalar-Plain">Serverless</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Compiling Rules...</span>
</span><span class='line'><span class="l-Scalar-Plain">Serverless</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Compiling Triggers &amp; Feeds...</span>
</span><span class='line'><span class="l-Scalar-Plain">Serverless</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Deploying Functions...</span>
</span><span class='line'><span class="l-Scalar-Plain">Serverless</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Deployment successful!</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Service Information</span>
</span><span class='line'><span class="l-Scalar-Plain">platform</span><span class="err">:   </span><span class="l-Scalar-Plain">openwhisk.ng.bluemix.net</span>
</span><span class='line'><span class="l-Scalar-Plain">namespace</span><span class="err">:  </span><span class="l-Scalar-Plain">_</span>
</span><span class='line'><span class="l-Scalar-Plain">service</span><span class="err">:    </span><span class="l-Scalar-Plain">smsbot</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">actions</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">smsbot-dev-incoming    smsbot-dev-reply</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">triggers</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="err">*</span><span class="nv">*no</span> <span class="l-Scalar-Plain">triggers deployed**</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">rules</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="err">*</span><span class="nv">*no</span> <span class="l-Scalar-Plain">rules deployed**</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">endpoints</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="err">*</span><span class="nv">*no</span> <span class="l-Scalar-Plain">routes deployed**</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Twilio Webhook</h3>

<p>On the <a href="https://www.twilio.com/console/phone-numbers/incoming">Phone Numbers</a> page in the Twilio console, configure the &#8221;<em>Messaging</em>&#8221; webhook URL.</p>

<p>Use this Web Action URL, replacing <code>user@host.com_dev</code> with your namespace.</p>

<p><code>https://openwhisk.ng.bluemix.net/api/v1/experimental/web/user@host.com_dev/default/smsbot-dev-incoming.http</code></p>

<p><img src="/images/smsbot/twilio_sms_webhook.png"></p>

<h3>Outgoing Webhook</h3>

<p>Create a new <a href="https://api.slack.com/custom-integrations/outgoing-webhooks">Outgoing Webhook</a> integration for the Slack channel messages should appear in. Use <code>smsbot</code> as the <em>Trigger Word</em>.</p>

<p>Use this Web Action URL, replacing <code>user@host.com_dev</code> with your namespace.</p>

<p><code>https://openwhisk.ng.bluemix.net/api/v1/experimental/web/user@host.com_dev/default/smsbot-dev-reply.json</code></p>

<p><img src="/images/smsbot/outgoing_webhook_trigger.png"></p>

<h3>Test it out!</h3>

<p>Send a text message to the phone number you registered through Twilio. smsbot should post the contents into Slack and send an SMS response with the message &#8221;<em>Thanks for letting us know!</em>&#8221;.</p>

<p><img src="/images/smsbot/slack_text_hidden.jpg"></p>

<p>If you send a channel message starting with the trigger word (<em>smsbot</em>), the phone number should receive a new SMS message with the message text.</p>

<p><img src="/images/smsbot/sms_app.png"></p>

<p>Awesome-sauce üòé.</p>

<h2>Conclusions</h2>

<p><a href="https://github.com/openwhisk/openwhisk/blob/master/docs/webactions.md">OpenWhisk Web Actions</a> provide a convenient way to expose serverless functions as simple HTTP APIs. This feature is ideal for implementing webhook endpoints.</p>

<p>Both Slack and Twilio provide webhook integration for developers to use their platforms. Using OpenWhisk Web Actions, we can write serverless functions that act as a bridge between these services. With less than a hundred lines of code, we&#8217;ve created a new slack bot that can connect users to channels using SMS messages.</p>

<p>Pretty cool, huh?! üëèüëèüëè</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/02/09/openwhisk-and-the-serverless-framework/">Openwhisk and the Serverless Framework</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-02-09T15:04:00+00:00" pubdate data-updated="true">Feb 9<span>th</span>, 2017</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://serverless.com">The Serverless Framework</a> is the most popular open-source framework for building serverless applications.</p>

<p><a href="https://serverless.com/blog/serverless-v1.6.0/">Recent releases</a> included support for using the framework with non-AWS providers. This feature makes it easier for developers to try different serverless platforms and move applications between providers.</p>

<p>Since last summer, I&#8217;ve been <a href="https://github.com/serverless/serverless-openwhisk">leading the technical effort</a> to provide an <a href="http://openwhisk.org/">OpenWhisk</a> provider plugin for the framework.</p>

<p>OpenWhisk is the first non-AWS serverless provider to complete integration into the framework.</p>

<p><img src="https://cloud.githubusercontent.com/assets/20538501/22434123/748ae372-e6e0-11e6-86d0-38db9941552d.png"></p>

<h2>Getting Started</h2>

<p>Documentation for the provider plugin is available on <a href="https://serverless.com/framework/docs/">The Serverless Framework&#8217;s website</a>.</p>

<p>Example projects using the framework to build applications for OpenWhisk are now available in <a href="https://github.com/serverless/examples">this repository</a>.</p>

<p>More details on the provider plugin can be found on the <a href="https://github.com/serverless/serverless-openwhisk">project repository</a>.</p>

<p>Found an issue? Feature request? Need help? Please <a href="https://github.com/serverless/serverless-openwhisk/issues">open issues on Github</a>.</p>

<h2>Video Demonstration</h2>

<iframe width="560" height="315" src="https://www.youtube.com/embed/GJY10W98Itc" frameborder="0" allowfullscreen></iframe>


<h2>Serverless Meetup Presentation</h2>

<p>Last week, I was invited to speak at the <a href="https://www.meetup.com/Serverless-London/events/236664340/">London&#8217;s Serverless Meetup</a> about building multi-provider serverless applications using this feature.</p>

<p>Slides from the presentation are here:</p>

<script async class="speakerdeck-embed" data-id="592fbd47aceb4fbc9021ae3bf2f6b06c" data-ratio="1.77777777777778" src="//speakerdeck.com/assets/embed.js"></script>


<p>There is a (low-fi) video recording from the event here:</p>

<iframe src="https://player.twitch.tv/?video=v119142073&autoplay=false" frameborder="0" allowfullscreen="true" scrolling="no" height="378" width="620"></iframe>


<p><a href="https://www.twitch.tv/serverlessldn?tt_medium=live_embed&tt_content=text_link" style="padding:2px 0px 4px; display:block; width:345px; font-weight:normal; font-size:10px; text-decoration:underline;">Watch live video from serverlessldn on www.twitch.tv</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/01/18/openwhisk-and-rust/">OpenWhisk and Rust</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-01-18T09:00:00+00:00" pubdate data-updated="true">Jan 18<span>th</span>, 2017</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>This blog post is <a href="http://jamesthom.as/blog/2017/01/16/openwhisk-docker-actions/">one of</a> <a href="http://jamesthom.as/blog/2017/01/17/openwhisk-and-go/">a series</a> looking at using Docker Actions in OpenWhisk to support extra runtimes.</em></p>

<p>Let&#8217;s look at writing serverless functions for <a href="http://openwhisk.org/">OpenWhisk</a> using <a href="https://rust-lang.org">Rust</a>.</p>

<blockquote><p>Rust is a systems programming language that runs blazingly fast, prevents segfaults, and guarantees thread safety.</p></blockquote>


<p>Rust has been growing in popularity since it launched in 2010. Rust is a popular language for writing microservices due to the focus on the attention to safety and strong concurrency support.</p>

<p>None of the major serverless platform natively support Rust at the moment. OpenWhisk does not include this as a default runtime. However, <a href="https://www.ibm.com/blogs/bluemix/2017/01/docker-bluemix-openwhisk/">recent updates</a> to OpenWhisk provide a path for writing serverless functions with Rust.</p>

<p>Let&#8217;s re-write <a href="http://jamesthom.as/blog/2017/01/17/openwhisk-and-go/">the example</a> from the previous post in Rust and see how to get it running using this new approach‚Ä¶</p>

<p><strong><em>Have you seen <a href="http://jamesthom.as/blog/2017/01/16/openwhisk-docker-actions/">this post</a> explaining how Docker-based Actions work? This post assumes you have already read that first.</em></strong></p>

<h2>Rust Language Actions</h2>

<p>Rust has a <a href="http://doc.crates.io/guide.html">build system</a> that supports creating static binaries. These binaries contain the application source code and dependent libraries.</p>

<p>Using the same approach as the <a href="http://jamesthom.as/blog/2017/01/17/openwhisk-and-go/">Go-based example</a>, bundling this binary into a zip file allows us to overwrite the <a href="https://github.com/openwhisk/openwhisk/blob/master/core/actionProxy/stub.sh">runtime stub</a> prior to invocation.</p>

<p>Runtime binaries will be executed by the <a href="https://github.com/openwhisk/openwhisk/blob/master/core/actionProxy/actionproxy.py">Python-based invoker</a> for each invocation. Request parameters will be passed as a JSON string using the first command-line argument. The invoker expects the Action result to be written to standard output as a JSON string.</p>

<h3>Action Source Code</h3>

<p>Here&#8217;s a simple Rust function that returns a greeting string from an input parameter. It parses the JSON string provided on the command-line to look for a <code>name</code> parameter. If this isn&#8217;t present, it defaults to <code>stranger</code>. It returns a JSON object with the greeting string (<code>msg</code>) by writing to the console.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">extern</span> <span class="n">crate</span> <span class="n">rustc_serialize</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="n">rustc_serialize</span><span class="o">::</span><span class="n">json</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="n">rustc_serialize</span><span class="o">::</span><span class="n">json</span><span class="o">::</span><span class="n">Json</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="n">std</span><span class="o">::</span><span class="n">env</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#[derive(RustcDecodable, RustcEncodable)]</span>
</span><span class='line'><span class="n">pub</span> <span class="n">struct</span> <span class="n">Greeting</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">message</span><span class="o">:</span> <span class="n">String</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">let</span> <span class="k">mut</span> <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;stranger&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// first arg contains JSON parameters</span>
</span><span class='line'>    <span class="k">if</span> <span class="k">let</span> <span class="n">Some</span><span class="p">(</span><span class="n">arg1</span><span class="p">)</span> <span class="o">=</span> <span class="n">env</span><span class="o">::</span><span class="n">args</span><span class="p">().</span><span class="n">nth</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// parse JSON and extract &#39;name&#39; field</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">params</span> <span class="o">=</span> <span class="n">Json</span><span class="o">::</span><span class="n">from_str</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg1</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="k">let</span> <span class="n">Some</span><span class="p">(</span><span class="n">params_obj</span><span class="p">)</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="n">as_object</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="k">let</span> <span class="n">Some</span><span class="p">(</span><span class="n">params_name</span><span class="p">)</span> <span class="o">=</span> <span class="n">params_obj</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">name</span> <span class="o">=</span> <span class="n">params_name</span><span class="p">.</span><span class="n">as_string</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">to_string</span><span class="p">();</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">let</span> <span class="n">greeting</span> <span class="o">=</span> <span class="n">Greeting</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">message</span><span class="o">:</span> <span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Hello, {}!&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">::</span><span class="n">encode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">greeting</span><span class="p">).</span><span class="n">unwrap</span><span class="p">());</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Set Up Project</h3>

<p>Using Rust&#8217;s package management tool, create a new project for our serverless function.</p>

<p>Add the source code above into the <code>src/main.rs</code> file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>cargo new action; <span class="nb">cd </span>action
</span><span class='line'>     Created library <span class="sb">`</span>action<span class="sb">`</span> project
</span><span class='line'><span class="nv">$ </span>mv src/lib.rs src/main.rs
</span><span class='line'><span class="nv">$ </span>vim src/main.rs
</span><span class='line'><span class="nv">$ </span>tree .
</span><span class='line'>.
</span><span class='line'>‚îú‚îÄ‚îÄ Cargo.toml
</span><span class='line'>‚îî‚îÄ‚îÄ src
</span><span class='line'>    ‚îî‚îÄ‚îÄ main.rs
</span><span class='line'>
</span><span class='line'>1 directory, 2 files
</span></code></pre></td></tr></table></div></figure>


<p>This function uses the <code>rustc-serialize</code> crate to handle parsing and producing JSON.</p>

<p>Add this identifier to the project&#8217;s dependencies listed in <code>Cargo.toml</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>package<span class="o">]</span>
</span><span class='line'><span class="nv">name</span> <span class="o">=</span> <span class="s2">&quot;action&quot;</span>
</span><span class='line'><span class="nv">version</span> <span class="o">=</span> <span class="s2">&quot;0.1.0&quot;</span>
</span><span class='line'><span class="nv">authors</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;Me &lt;me@email.com&gt;&quot;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>dependencies<span class="o">]</span>
</span><span class='line'>rustc-serialize <span class="o">=</span> <span class="s2">&quot;0.3&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Build and run the binary to test it works as expected.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="err">$</span> <span class="nx">cargo</span> <span class="nx">run</span>
</span><span class='line'>    <span class="nx">Updating</span> <span class="nx">registry</span> <span class="s">`https://github.com/rust-lang/crates.io-index`</span>
</span><span class='line'>   <span class="nx">Compiling</span> <span class="nx">rustc</span><span class="o">-</span><span class="nx">serialize</span> <span class="nx">v0</span><span class="mf">.3.22</span>
</span><span class='line'>   <span class="nx">Compiling</span> <span class="nx">action</span> <span class="nx">v0</span><span class="mf">.1.0</span> <span class="p">(</span><span class="nx">file</span><span class="p">:</span><span class="c1">///private/tmp/test/action)</span>
</span><span class='line'>    <span class="nx">Finished</span> <span class="nx">debug</span> <span class="p">[</span><span class="nx">unoptimized</span> <span class="o">+</span> <span class="nx">debuginfo</span><span class="p">]</span> <span class="nx">target</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="nx">in</span> <span class="mf">7.0</span> <span class="nx">secs</span>
</span><span class='line'>     <span class="nx">Running</span> <span class="s">`target/debug/action`</span>
</span><span class='line'><span class="p">{</span><span class="s">&quot;message&quot;</span><span class="p">:</span><span class="s">&quot;Hello, stranger!&quot;</span><span class="p">}</span>
</span><span class='line'><span class="err">$</span> <span class="nx">cargo</span> <span class="nx">run</span> <span class="err">&#39;</span><span class="p">{</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;James&quot;</span><span class="p">}</span><span class="err">&#39;</span>
</span><span class='line'>    <span class="nx">Finished</span> <span class="nx">debug</span> <span class="p">[</span><span class="nx">unoptimized</span> <span class="o">+</span> <span class="nx">debuginfo</span><span class="p">]</span> <span class="nx">target</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="nx">in</span> <span class="mf">0.0</span> <span class="nx">secs</span>
</span><span class='line'>     <span class="nx">Running</span> <span class="s">`target/debug/action {\&quot;name\&quot;:\ \&quot;James\&quot;}`</span>
</span><span class='line'><span class="p">{</span><span class="s">&quot;message&quot;</span><span class="p">:</span><span class="s">&quot;Hello, James!&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Before we can deploy this binary to OpenWhisk, it must be compiled for the platform architecture.</em></p>

<h3>Cross-Compiling Locally</h3>

<p>Rust&#8217;s compiler uses LLVM under the covers, making it possible to generate machine code for different architectures. Cross-compiling for different platforms requires having the correct compiler, linker and libraries for that architecture installed.</p>

<p>Rust <a href="https://blog.rust-lang.org/2016/05/13/rustup.html">recently released</a> a <a href="https://rustup.rs/">toolchain manager</a> to simplify this process.</p>

<p>Install the Rust toolchain for the <code>x86_64-unknown-linux-musl</code> runtime.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>rustup target add x86_64-unknown-linux-musl
</span><span class='line'>info: downloading component <span class="s1">&#39;rust-std&#39;</span> <span class="k">for</span> <span class="s1">&#39;x86_64-unknown-linux-musl&#39;</span>
</span><span class='line'>info: installing component <span class="s1">&#39;rust-std&#39;</span> <span class="k">for</span> <span class="s1">&#39;x86_64-unknown-linux-musl&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Install musl-based GCC cross-compilers.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>brew install filosottile/musl-cross/musl-cross
</span></code></pre></td></tr></table></div></figure>


<p>Add the configuration file to set the correct linker for the runtime.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>cat .cargo/config
</span><span class='line'><span class="o">[</span>target.x86_64-unknown-linux-musl<span class="o">]</span>
</span><span class='line'><span class="nv">linker</span> <span class="o">=</span> <span class="s2">&quot;x86_64-linux-musl-gcc&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can now cross-compile the binary for the correct environment.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>cargo build --target<span class="o">=</span>x86_64-unknown-linux-musl --release
</span><span class='line'>   Compiling rustc-serialize v0.3.22
</span><span class='line'>   Compiling action v0.1.0 <span class="o">(</span>file:///Users/james/code/bluemix/openwhisk-languages/rust/action<span class="o">)</span>
</span><span class='line'>    Finished release <span class="o">[</span>optimized<span class="o">]</span> target<span class="o">(</span>s<span class="o">)</span> in 9.30 secs
</span></code></pre></td></tr></table></div></figure>


<p>Checking the file type demonstrates we have built a static binary for the Linux x86_64 platform.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>file target/x86_64-unknown-linux-musl/release/action
</span><span class='line'>target/x86_64-unknown-linux-musl/release/action: ELF 64-bit LSB executable, x86-64, version 1 <span class="o">(</span>GNU/Linux<span class="o">)</span>, statically linked, not stripped
</span></code></pre></td></tr></table></div></figure>


<h3>Cross-Compiling Using Docker</h3>

<p>If you don&#8217;t want to install the Rust development toolchain, Docker can be used to start a container with the <a href="https://github.com/emk/rust-musl-builder">environment set up</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker pull ekidd/rust-musl-builder
</span><span class='line'><span class="nv">$ </span>docker run -it -v <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>:/home/rust/src ekidd/rust-musl-builder cargo build --release
</span><span class='line'>    Updating registry <span class="sb">`</span>https://github.com/rust-lang/crates.io-index<span class="sb">`</span>
</span><span class='line'> Downloading rustc-serialize v0.3.22
</span><span class='line'>   Compiling action v0.1.0 <span class="o">(</span>file:///home/rust/src<span class="o">)</span>
</span><span class='line'>    Finished release <span class="o">[</span>optimized<span class="o">]</span> target<span class="o">(</span>s<span class="o">)</span> in 1.80 secs
</span><span class='line'><span class="nv">$ </span>file target/x86_64-unknown-linux-musl/release/action
</span><span class='line'>target/x86_64-unknown-linux-musl/release/action: ELF 64-bit LSB executable, x86-64, version 1 <span class="o">(</span>GNU/Linux<span class="o">)</span>, statically linked, not stripped
</span></code></pre></td></tr></table></div></figure>


<h3>Create &amp; Deploy Archive</h3>

<p>Add the binary to a zip file, ensuring the file is named <code>exec</code> in the archive.</p>

<p>Use the <code>wsk</code> command-line to create a new Docker Action using this archive.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>cp target/x86_64-unknown-linux-musl/release/action <span class="nb">exec</span>
</span><span class='line'><span class="nv">$ </span>zip action.zip <span class="nb">exec</span>
</span><span class='line'><span class="nb">  </span>adding: <span class="nb">exec</span> <span class="o">(</span>deflated 64%<span class="o">)</span>
</span><span class='line'><span class="nv">$ </span>wsk action create rust_test action.zip --native
</span><span class='line'>ok: created action rust_test
</span></code></pre></td></tr></table></div></figure>


<h3>Invoking Action</h3>

<p>Test the action from the command-line to verify it works.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>wsk action invoke rust_test --result
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;msg&quot;</span>: <span class="s2">&quot;Hello, Stranger!&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="nv">$ </span>wsk action invoke rust_test --result --param name James
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;msg&quot;</span>: <span class="s2">&quot;Hello, James!&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Success üòé.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/01/17/openwhisk-and-go/">Openwhisk and Go</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-01-17T09:00:00+00:00" pubdate data-updated="true">Jan 17<span>th</span>, 2017</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://jamesthom.as/blog/2016/06/21/serverless-go-actions/">In an earlier blog post</a>, I explained how to use Go language binaries on OpenWhisk using Docker-based Actions. It relied on building Docker images for each serverless function and hosting them on Docker Hub.</p>

<p><a href="https://www.ibm.com/blogs/bluemix/2017/01/docker-bluemix-openwhisk/">Recent updates</a>  to Docker-based Actions have made this process much simpler. Developers don&#8217;t need to build and expose public images anymore.</p>

<p>Let&#8217;s re-visit the example from the previous post and see how to get it running using this new approach‚Ä¶</p>

<p><strong><em>Have you seen <a href="http://jamesthom.as/blog/2017/01/16/openwhisk-docker-actions/">this post</a> explaining how Docker-based Actions work? This post assumes you have already read that first.</em></strong></p>

<h2>Go Language Actions</h2>

<p>Go&#8217;s <a href="https://golang.org/pkg/go/build/">build system</a> combines application source code and dependencies into a single execution binary. Bundling this binary into a zip file allows us to overwrite the <a href="https://github.com/openwhisk/openwhisk/blob/master/core/actionProxy/stub.sh">runtime stub</a> prior to invocation.</p>

<p>Runtime binaries will be executed by the <a href="https://github.com/openwhisk/openwhisk/blob/master/core/actionProxy/actionproxy.py">Python-based invoker</a> for each invocation. Request parameters will be passed as a JSON string using the first command-line argument. The invoker expects the Action result to be written to standard output as a JSON string.</p>

<h3>Action Source Code</h3>

<p>Here&#8217;s a simple Go function that returns a greeting string from an input parameter. It parses the JSON string provided on the command-line to look for a <code>name</code> parameter. If this isn&#8217;t present, it defaults to <code>Stranger</code>. It returns a JSON object with the greeting string (<code>msg</code>) by writing to the console.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="s">&quot;encoding/json&quot;</span>
</span><span class='line'><span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>
</span><span class='line'><span class="kn">import</span> <span class="s">&quot;os&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// native actions receive one argument, the JSON object as a string</span>
</span><span class='line'>  <span class="nx">arg</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// unmarshal the string to a JSON object</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">obj</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>
</span><span class='line'>  <span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">arg</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">obj</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">name</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">obj</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">name</span> <span class="p">=</span> <span class="s">&quot;Stranger&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">msg</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;msg&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s">&quot;Hello, &quot;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s">&quot;!&quot;</span><span class="p">)}</span>
</span><span class='line'>  <span class="nx">res</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">res</span><span class="p">))</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Building this locally allows us to test it works.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="err">$</span> <span class="k">go</span> <span class="nx">run</span> <span class="nx">test</span><span class="p">.</span><span class="k">go</span> <span class="err">&#39;</span><span class="p">{</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;James&quot;</span><span class="p">}</span><span class="err">&#39;</span>
</span><span class='line'><span class="p">{</span><span class="s">&quot;msg&quot;</span><span class="p">:</span><span class="s">&quot;Hello, James!&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Before we can deploy this binary to OpenWhisk, it must be compiled for the platform architecture.</em></p>

<h3>Cross-Compiling Locally</h3>

<p>Go 1.5 <a href="https://dave.cheney.net/2015/08/22/cross-compilation-with-go-1-5">introduced much improved</a> support for cross-compilation.</p>

<p>If you have the development environment installed locally, you can compile the binary for another platform by setting environment variables. The full list of supported architectures is available <a href="https://golang.org/doc/install/source#environment">here</a>.</p>

<p><em>OpenWhisk uses an <a href="https://hub.docker.com/_/alpine/">Alpine Linux-based</a> environment to execute Actions.</em></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>env <span class="nv">GOOS</span><span class="o">=</span>linux <span class="nv">GOARCH</span><span class="o">=</span>amd64 go build exec.go
</span></code></pre></td></tr></table></div></figure>


<p>Checking the file type demonstrates we have built a static binary for the Linux x86_64 platform.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>file <span class="nb">exec</span>
</span><span class='line'><span class="nb">exec</span>: ELF 64-bit LSB executable, x86-64, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, statically linked, not stripped
</span></code></pre></td></tr></table></div></figure>


<h3>Cross-Compiling Using Docker</h3>

<p>If you don&#8217;t want to install the Go development toolchain, Docker can be used to start a container with the environment set up.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker pull golang
</span><span class='line'><span class="nv">$ </span>docker run -it -v <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>:/go/src golang
</span><span class='line'>root@0a2f1655eece:/go# <span class="nb">cd </span>src/
</span><span class='line'>root@0a2f1655eece:/go/src# go build exec.go
</span><span class='line'>root@0a2f1655eece:/go/src# ls
</span><span class='line'><span class="nb">exec  </span>exec.go
</span><span class='line'><span class="nv">$ </span>file <span class="nb">exec</span>
</span><span class='line'><span class="nb">exec</span>: ELF 64-bit LSB executable, x86-64, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, statically linked, not stripped
</span></code></pre></td></tr></table></div></figure>


<h3>Create &amp; Deploy Archive</h3>

<p>Add the binary to a zip file, ensuring the file is named <code>exec</code> in the archive.</p>

<p>Use the <code>wsk</code> command-line to create a new Docker Action using this archive.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>zip action.zip <span class="nb">exec</span>
</span><span class='line'><span class="nb">  </span>adding: <span class="nb">exec</span> <span class="o">(</span>deflated 66%<span class="o">)</span>
</span><span class='line'><span class="nv">$ </span>wsk action create go_test action.zip --docker
</span><span class='line'>ok: created action go_test
</span></code></pre></td></tr></table></div></figure>


<h3>Invoking Action</h3>

<p>Test the action from the command-line to verify it works.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>wsk action invoke go_test --blocking --result
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;msg&quot;</span>: <span class="s2">&quot;Hello, Stranger!&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="nv">$ </span>wsk action invoke go_test --blocking --result --param name James
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;msg&quot;</span>: <span class="s2">&quot;Hello, James!&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Success üòé.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/01/16/openwhisk-docker-actions/">OpenWhisk Docker Actions</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-01-16T11:05:00+00:00" pubdate data-updated="true">Jan 16<span>th</span>, 2017</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://openwhisk.org/">OpenWhisk</a> recently announced the <a href="https://www.ibm.com/blogs/bluemix/2017/01/docker-bluemix-openwhisk/">following changes</a> to Docker-based Actions.</p>

<p>Developers can now deploy runtime files to the Action environment prior to invocation.</p>

<p>This makes it much easier to support (<em>almost</em>) any programming language in OpenWhisk. Awesome!</p>

<p>Let&#8217;s start by explaining how this new feature works&#8230;</p>

<h2>Docker Actions</h2>

<p>Docker Actions in OpenWhisk are <a href="https://github.com/openwhisk/openwhisk/blob/master/core/actionProxy/Dockerfile">built</a> from the following <a href="https://github.com/openwhisk/openwhisk/tree/master/core/actionProxy">repository</a> using the <a href="https://github.com/docker-library/python/blob/693a75332e8ae5ad3bfae6e8399c4d7cc3cb6181/2.7/alpine/Dockerfile">python:2.7.12-alpine</a> base image. This image is available on Docker Hub as <a href="https://hub.docker.com/r/openwhisk/dockerskeleton/"><code>openwhisk/dockerskeletion</code></a>.</p>

<p>The image includes a Python application which <a href="https://github.com/openwhisk/openwhisk/blob/master/core/actionProxy/actionproxy.py">implements the HTTP API</a> used to handle platform requests, e.g. <em>invoke the action with these parameters</em>.</p>

<p>This service executes a file (<code>/action/exec</code>) for each invocation. Replacing this file allows us to control the runtime environment.</p>

<p>Request parameters are passed, using a JSON string, as the first command-line argument. Response values are interpreted as JSON written to <code>stdout</code>.</p>

<p>Developers can now include a zip file when creating Docker-based Actions. This archive will be extracted into the <code>/action</code> directory prior to invocations. If the archive contains a file named <code>exec</code> this will replace the exectuable file called by the invocation handler.</p>

<h3>Testing It Out</h3>

<p>Using the <code>wsk</code> command-line, developers can create Actions using this Docker image.</p>

<p>If the archive file is missing, the <code>/action/exec</code> path contains the the following <a href="https://github.com/openwhisk/openwhisk/blob/master/core/actionProxy/stub.sh">stub file</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>wsk action create skeleton --docker openwhisk/dockerskeleton
</span><span class='line'>ok: created action skeleton
</span><span class='line'><span class="nv">$ </span>wsk action invoke skeleton --blocking --result
</span><span class='line'><span class="o">{</span> <span class="s2">&quot;error&quot;</span>: <span class="s2">&quot;This is a stub action. Replace it with custom logic.&quot;</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&#8217;s update this stub file to return a custom greeting.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>cat <span class="nb">exec</span>
</span><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;{ \&quot;hello\&quot;: \&quot;ran without a docker pull!\&quot; }&quot;</span>
</span><span class='line'><span class="nv">$ </span>./exec
</span><span class='line'><span class="o">{</span> <span class="s2">&quot;hello&quot;</span>: <span class="s2">&quot;ran without a docker pull!&quot;</span> <span class="o">}</span>
</span><span class='line'><span class="nv">$ </span>zip exec.zip <span class="nb">exec</span>
</span><span class='line'><span class="nb">  </span>adding: <span class="nb">exec</span> <span class="o">(</span>stored 0%<span class="o">)</span>
</span><span class='line'><span class="nv">$ </span>wsk action create custom_docker_action exec.zip --docker
</span><span class='line'>ok: created action custom_docker_action
</span><span class='line'><span class="nv">$ </span>wsk action invoke custom_docker_action --blocking --result
</span><span class='line'><span class="o">{</span> <span class="s2">&quot;hello&quot;</span>: <span class="s2">&quot;ran without a docker pull!&quot;</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The archive file could include a static binary, or even a complete runtime, to replace the <code>exec</code> stub.</p>

<p>All files in the archive file will be available under the <code>/action</code> directory.</p>

<h2>Running Locally</h2>

<p>The <code>openwhisk/dockerskeleton</code> image exposes a Python-based HTTP server on port 8080.</p>

<p>Pulling the <code>openwhisk/dockerskeleton</code> image from Docker Hub allows us to run it locally for development.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker pull openwhisk/dockerskeleton
</span><span class='line'><span class="nv">$ </span>docker run -it -p 8080:8080 openwhisk/dockerskeleton
</span></code></pre></td></tr></table></div></figure>


<p>The platform uses the following HTTP endpoints to initialise and invoke Actions.</p>

<ul>
<li><code>POST /init</code> -> Set up Action source from JSON payload.</li>
<li><code>POST /run</code> -> Invoke Action</li>
</ul>


<h3>Initialising The Environment</h3>

<p>Before invoking Actions using this image, we need to deploy and unpack the archive file into the <code>/action</code> directory.</p>

<p>Reviewing the <a href="https://github.com/openwhisk/openwhisk/blob/master/core/actionProxy/actionproxy.py#L47-L80">Python source code</a>, the platform triggers this by sending a HTTP POST with the following JSON to <code>/init</code> endpoint.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;binary&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>code</code> contains the archive file as a base64 encoded string.</p>

<p>Let&#8217;s try this out using the action archive we created above.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>base64 exec.zip  | <span class="nb">echo</span> <span class="s2">&quot;\&quot;$(cat)\&quot;&quot;</span> | jq <span class="s1">&#39;{value: {binary: true, code: .}}&#39;</span> &gt; init.json
</span><span class='line'><span class="nv">$ </span>cat init.json
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;value&quot;</span>: <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;binary&quot;</span>: <span class="nb">true</span>,
</span><span class='line'>    <span class="s2">&quot;code&quot;</span>: <span class="s2">&quot;UEsDBAoAAAAAAOlqMEr1+JNAQQAAAEEAAAAEABwAZXhlY1VUCQADRcl8WFDJfFh1eAsAAQT1AQAABBQAAAAjIS9iaW4vYmFzaAplY2hvICJ7IFwiaGVsbG9cIjogXCJyYW4gd2l0aG91dCBhIGRvY2tlciBwdWxsIVwiIH0iClBLAQIeAwoAAAAAAOlqMEr1+JNAQQAAAEEAAAAEABgAAAAAAAEAAADtgQAAAABleGVjVVQFAANFyXxYdXgLAAEE9QEAAAQUAAAAUEsFBgAAAAABAAEASgAAAH8AAAAAAA==&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can issue the HTTP request to push this archive into the container.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>http post localhost:8080/init &lt; init.json
</span><span class='line'>HTTP/1.1 200 OK
</span><span class='line'>Content-Length: 2
</span><span class='line'>Content-Type: text/html; <span class="nv">charset</span><span class="o">=</span>utf-8
</span><span class='line'>Date: Mon, 16 Jan 2017 14:11:04 GMT
</span><span class='line'>
</span><span class='line'>OK
</span></code></pre></td></tr></table></div></figure>


<p>Accessing the container filesystem allows us to verify the archive has been extracted correctly.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker ps
</span><span class='line'>CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS              PORTS                    NAMES
</span><span class='line'>b37a7dc1cab1        openwhisk/dockerskeleton      <span class="s2">&quot;/bin/bash -c &#39;cd ...&quot;</span>   About an hour ago   Up About an hour    0.0.0.0:8080-&gt;8080/tcp   relaxed_davinci
</span><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it b37a7dc1cab1 /bin/sh
</span><span class='line'>/ <span class="c"># cd /action</span>
</span><span class='line'>/action <span class="c"># ls</span>
</span><span class='line'><span class="nb">exec</span>
</span><span class='line'>/action <span class="c"># cat exec</span>
</span><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;{ \&quot;hello\&quot;: \&quot;ran without a docker pull!\&quot; }&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Invocation Requests</h3>

<p>Action invocations are triggered by sending a HTTP POST to the <code>/run</code> endpoint.</p>

<p>This endpoint expects the following JSON body.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;value&quot;</span>: <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;foo&quot;</span>: <span class="s2">&quot;bar&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The inner object parameters under the <code>value</code> property are passed, as a JSON string, to the executable as the first command-line argument.</p>

<p>Sending this request to our container will trigger the shell script from our archive and return the JSON response.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;{}&quot;</span> | jq <span class="s1">&#39;{value: .}&#39;</span> | http post localhost:8080/run
</span><span class='line'>HTTP/1.1 200 OK
</span><span class='line'>Content-Length: 44
</span><span class='line'>Content-Type: application/json
</span><span class='line'>Date: Mon, 16 Jan 2017 14:17:15 GMT
</span><span class='line'>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;hello&quot;</span>: <span class="s2">&quot;ran without a docker pull!&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>Recent updates to Docker-based Actions in OpenWhisk make it much easier to customise the runtime environment.</p>

<p>Being able to deploy arbitrary files into the runtime container, prior to invocation, simplifies the process of supporting new runtimes.</p>

<p>Hopefully this blog post has shown you how to get started with this feature.</p>

<p>Over the next few weeks, we&#8217;re going to show you how to use this approach to run lots of new programming languages on the platform. Stay tuned for updates&#8230;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/11/28/npm-modules-in-openwhisk/">NPM Modules in OpenWhisk</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-11-28T14:03:00+00:00" pubdate data-updated="true">Nov 28<span>th</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>OpenWhisk now <a href="https://github.com/openwhisk/openwhisk/blob/master/docs/actions.md#packaging-an-action-as-a-nodejs-module">supports creating Node.js Actions from a zip file</a>. The archive file will be extracted into the runtime environment by the platform. This allows us to split microservice logic across multiple files, use third-party <a href="https://www.npmjs.com/">NPM modules</a> or include non-JavaScript assets (configuration files, images, HTML files).</p>

<h2>&#8220;Hello World&#8221; Example</h2>

<p>Let&#8217;s look at a &#8220;Hello World&#8221; example of registering a serverless function from a zip file. Our archive will contain two files, the <a href="https://docs.npmjs.com/files/package.json">package descriptor</a> and a JavaScript file.</p>

<p>Here is the minimal <code>package.json</code> file required for loading a module from a directory.</p>

<figure class='code'><figcaption><span>package.json</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;main&quot;</span><span class="p">:</span> <span class="s2">&quot;my_file.js&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In <code>my_file.js</code>, a function is returned through the <code>main</code> property on the <code>exports</code> object. This function <a href="https://github.com/openwhisk/openwhisk/blob/master/docs/actions.md#creating-and-invoking-javascript-actions">implements the Action interface.</a></p>

<figure class='code'><figcaption><span>my_file.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">exports</span><span class="p">.</span><span class="nx">main</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span><span class="nx">result</span><span class="o">:</span> <span class="s2">&quot;Hello World&quot;</span><span class="p">};</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Creating a zip file from the current directory, we can deploy this Action through the command-line utility.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>zip -r action.zip *
</span><span class='line'><span class="nv">$ </span>wsk action create hello_world --kind nodejs:default action.zip
</span></code></pre></td></tr></table></div></figure>


<p>When this Action is invoked, the archive will be unzipped into a temporary directory. OpenWhisk loads the directory as a Node.js module and invokes the function property on the module for each invocation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>wsk action invoke hello_world --result
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;result&quot;</span>: <span class="s2">&quot;Hello world&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Using NPM Dependencies</h2>

<p>Let&#8217;s look a more complicated example which uses an external <a href="https://www.npmjs.com/">NPM module</a> in our Action.</p>

<figure class='code'><figcaption><span>index.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">leftPad</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;left-pad&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">myAction</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">lines</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">lines</span> <span class="o">||</span> <span class="p">[];</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">{</span> <span class="nx">padded</span><span class="o">:</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">l</span> <span class="o">=&gt;</span> <span class="nx">leftPad</span><span class="p">(</span><span class="nx">l</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">))</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">exports</span><span class="p">.</span><span class="nx">main</span> <span class="o">=</span> <span class="nx">myAction</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This module uses the <a href="http://qz.com/646467/how-one-programmer-broke-the-internet-by-deleting-a-tiny-piece-of-code/">extremely popular</a> <a href="https://www.npmjs.com/package/left-pad">left-pad</a> module to process an array of strings, passed through a request parameter. The resulting output is returned in the response.</p>

<p>Before using this module, we need to install the dependencies listed in <code>package.json</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;my-action&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;main&quot;</span><span class="p">:</span> <span class="s2">&quot;index.js&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;dependencies&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;left-pad&quot;</span> <span class="p">:</span> <span class="s2">&quot;1.1.3&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>OpenWhisk does not automatically install dependencies listed in <code>package.json</code> in the runtime environment.</strong></p>

<p>The developer has to run <code>npm install</code> locally and include the <code>node_modules</code> directory in the zip file.</p>

<ul>
<li>Install NPM dependencies locally.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>npm install
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Create a <code>.zip</code> archive containing all files.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>zip -r action.zip *
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Create the action using command-line utility.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>wsk action create packageAction --kind nodejs:default action.zip
</span></code></pre></td></tr></table></div></figure>


<p>Now we can test out our action to check it works‚Ä¶.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>wsk action invoke --blocking --result packageAction --param lines <span class="s2">&quot;[\&quot;and now\&quot;, \&quot;for something completely\&quot;, \&quot;different\&quot; ]&quot;</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;padded&quot;</span>: <span class="o">[</span>
</span><span class='line'>        <span class="s2">&quot;.......................and now&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;......for something completely&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;.....................different&quot;</span>
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Native Module Dependencies</h2>

<p>Node.js provides a mechanism for JavaScript modules to <a href="https://nodejs.org/api/addons.html">include native platform code</a> as if they were ordinary modules. This is often used to improve performance by deferring operations to native C/C++ libraries. NPM handles compiling native code during the dependency install process.</p>

<p><strong>Using modules with native dependencies in Actions requires the native code to be compiled for the platform runtime.</strong></p>

<h3>Compiling dependencies with Docker</h3>

<p>One solution to this problem uses Docker to simulate the same runtime environment.</p>

<p>OpenWhisk uses Docker to manage the runtime environments for Actions. The <a href="https://github.com/docker-library/buildpack-deps/blob/af914a5bde2a749884177393c8140384048dc5f9/trusty/curl/Dockerfile"><em>buildpack-deps:trusty-curl</em></a> image is used as the <a href="https://github.com/openwhisk/openwhisk/blob/master/core/nodejsActionBase/Dockerfile">base image for all Node.js Actions</a>.</p>

<p>Running a local container from this image will give access to the same runtime environment. Running <code>npm install</code> within this container will produce the <code>node_modules</code> directory with native code compiled for the correct architecture.</p>

<h3>Action With Native Modules</h3>

<p>Let&#8217;s look at an example‚Ä¶</p>

<figure class='code'><figcaption><span>index.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">SHA3</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sha3&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">SHA</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SHA3</span><span class="p">.</span><span class="nx">SHA3Hash</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">d</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">payload</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span> <span class="nx">sha</span><span class="o">:</span> <span class="nx">d</span><span class="p">.</span><span class="nx">digest</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span> <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">exports</span><span class="p">.</span><span class="nx">main</span> <span class="o">=</span> <span class="nx">SHA</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This module returns a function that calculates a SHA3 cryptographic hash for the invocation payload. The hex string for the hash is returned as the function response.</p>

<p>The NPM module (<a href="https://www.npmjs.com/package/sha3">sha3</a>) used to calculate the digest uses a C++ extension for the hashing algorithm.</p>

<figure class='code'><figcaption><span>package.json</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;hashing-service&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;main&quot;</span><span class="p">:</span> <span class="s2">&quot;index.js&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;sha3&quot;</span><span class="p">:</span> <span class="s2">&quot;^1.2.0&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Action Runtime Environments</h3>

<p>OpenWhisk uses a <a href="https://github.com/docker-library/buildpack-deps/blob/af914a5bde2a749884177393c8140384048dc5f9/trusty/curl/Dockerfile">public Docker image</a> as the base image for the Action environments. It then <a href="https://github.com/openwhisk/openwhisk/blob/master/core/nodejs6Action/Dockerfile">builds a custom image</a> by installing Node.js and NPM for the particular runtime version.</p>

<p>Rather than building this image ourselves, we can use existing images published on <a href="https://hub.docker.com/">Docker Hub</a>.</p>

<p><a href="https://nodesource.com/">NodeSource</a> provides <a href="https://hub.docker.com/u/nodesource/">public Docker images pre-installed with different Node.js versions</a>. Provided the base image (Ubuntu Trusty) and Node.js version (6.7) matches, the runtime environment will be the same.</p>

<p>Starting a local container from this image, we can use Docker&#8217;s <a href="https://docs.docker.com/engine/tutorials/dockervolumes/">host volume support</a> to mount the local directory into the host container.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker run -it -v <span class="s2">&quot;/action:/usr/src/app&quot;</span> nodesource/trusty:6.7 /bin/sh
</span></code></pre></td></tr></table></div></figure>


<p>Running <code>npm install</code> in the container, the <code>sha3</code> dependency is compiled and installed.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># npm install</span>
</span><span class='line'>
</span><span class='line'>&gt; sha3@1.2.0 install /usr/src/app/node_modules/sha3
</span><span class='line'>&gt; node-gyp rebuild
</span><span class='line'>
</span><span class='line'>make: Entering directory <span class="sb">`</span>/usr/src/app/node_modules/sha3/build<span class="s1">&#39;                                                       </span>
</span><span class='line'><span class="s1">make: Warning: File `sha3.target.mk&#39;</span> has modification <span class="nb">time </span>0.19 s in the future
</span><span class='line'>  CXX<span class="o">(</span>target<span class="o">)</span> Release/obj.target/sha3/src/addon.o
</span><span class='line'>  CXX<span class="o">(</span>target<span class="o">)</span> Release/obj.target/sha3/src/displayIntermediateValues.o
</span><span class='line'>  CXX<span class="o">(</span>target<span class="o">)</span> Release/obj.target/sha3/src/KeccakF-1600-reference.o
</span><span class='line'>  CXX<span class="o">(</span>target<span class="o">)</span> Release/obj.target/sha3/src/KeccakNISTInterface.o
</span><span class='line'>  CXX<span class="o">(</span>target<span class="o">)</span> Release/obj.target/sha3/src/KeccakSponge.o
</span><span class='line'>  SOLINK_MODULE<span class="o">(</span>target<span class="o">)</span> Release/obj.target/sha3.node
</span><span class='line'>  COPY Release/sha3.node
</span><span class='line'>make: warning:  Clock skew detected.  Your build may be incomplete.
</span><span class='line'>make: Leaving directory <span class="sb">`</span>/usr/src/app/node_modules/sha3/build<span class="err">&#39;</span>
</span><span class='line'>my-action@1.0.0 /usr/src/app
</span><span class='line'><span class="sb">`</span>-- sha3@1.2.0
</span><span class='line'>  <span class="sb">`</span>-- nan@2.4.0
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>node_modules</code> directory will be available on the host system after exiting the container. Repeat the steps above to archive the source files and deploy our serverless function.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>zip -r action.zip *
</span><span class='line'><span class="nv">$ </span>wsk action create packageAction --kind nodejs:6 action.zip
</span><span class='line'>ok: created action packageAction
</span></code></pre></td></tr></table></div></figure>


<p>Invoking the Action will now use the native code to produce hash values for the invocation parameters.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>wsk action invoke packageAction -b -p payload <span class="s2">&quot;Hello&quot;</span> --result
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;sha&quot;</span>: <span class="s2">&quot;c33fede18a1ae53ddb8663710f8054866beb714044fce759790459996196f101d94dfc7bd8268577f7ee3d2f8ff0cef4004a963222</span>
</span><span class='line'><span class="s2">7db84df62d2b40682d69e2&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Action Package Details</h2>

<p>Upon invocation, OpenWhisk extracts the action&#8217;s zip file to a temporary directory in the runtime environment. It then <a href="https://nodejs.org/api/modules.html#modules_all_together">loads the directory as a standard Node.js module</a>, using <code>require</code>.</p>

<p>Node.js expects the directory to have a valid <code>package.json</code> file. The <code>main</code> property is used to define which JavaScript file is evaluated when the module is loaded. This file can assign values to the global <code>exports</code> object. These references are then returned when <code>require</code> is called for this module.</p>

<p><strong>OpenWhisk expects the returned module object to have a property called <code>main</code> which references a function. This function will be executed for each invocation request.</strong></p>

<p>Request parameters are passed as object properties on the first function argument. The function must return an object for the invocation response.</p>

<p>Other files included in the archive will be available in the current working directory. These can also be loaded as modules or read directly from the file-system.</p>

<h2>Conclusions</h2>

<p>OpenWhisk support for Action packages is a huge step forward for the platform. Node.js has an enormous ecosystem of third-party modules. Developers can now easily use any of these modules within their Actions.</p>

<p>This feature can also be used to include non-JS files within the runtime environment. It would be possible to use configuration files in JSON or static assets like HTML or CSS files.</p>

<p><strong><em>The team are now working on providing support for other runtimes, watch this space‚Ä¶</em></strong></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/10/31/serverless-logs-with-elasticsearch/">Serverless Logs With Elasticsearch</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-10-31T10:39:00+00:00" pubdate data-updated="true">Oct 31<span>st</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://martinfowler.com/articles/serverless.html">Serverless platforms</a> can seem like magic.</p>

<p>Taking your code and turning it into scalable microservices in the cloud without having to set up or manage any infrastructure.</p>

<p><em>No provisioning VMs. No configuring Linux environments. No upgrading middleware packages.</em></p>

<p>Which is wonderful until something goes wrong with your microservices in production‚Ä¶</p>

<p><em>&#8220;Let me just log into the machine.&#8221;</em></p>

<p><strong>Serverless platforms do not allow this.</strong></p>

<p><em>No tracing system calls. No running top. No connecting a debugger to the process. You can&#8217;t even grep through the logs!</em></p>

<p>Many of the tools and techniques we use to diagnose bugs rely on having access to the environment.</p>

<p><em>Fortunately, we do still have access to logging output generated by our serverless functions. Phew.</em></p>

<p><strong>Storing, searching and analysing these logs is crucial to efficiently diagnosing and fixing issues on serverless platforms.</strong></p>

<p>In this blog post, we&#8217;re going to look at using a popular open-source solution to manage the logs being generated by our serverless functions. This solution is also known as &#8221;<a href="https://www.oreilly.com/ideas/understanding-the-elk-stack">The ELK Stack</a>&#8221;.</p>

<p><strong><em>TLDR: There is now a Logstash input plugin for OpenWhisk. This will automatically index serverless application logs into Elasticsearch. See here for usage instructions: <a href="https://github.com/jthomas/logstash-input-openwhisk">https://github.com/jthomas/logstash-input-openwhisk</a></em></strong></p>

<h2>Elasticsearch, Logstash and Kibana</h2>

<p>‚Ä¶are the three open-source projects that, when combined, are known as The ELK Stack. It provides a scalable search engine for indexed documents.</p>

<p><a href="https://github.com/elastic/elasticsearch">Elasticsearch</a> <em>&#8220;is a search engine based on Lucene. It provides a distributed, multitenant-capable full-text search engine with an HTTP web interface and schema-free JSON documents.&#8221;</em></p>

<p><a href="https://github.com/elastic/logstash">Logstash</a> is a tool for managing events and logs. You can use it to collect logs, parse them, and store them for later use (like, for searching). If you store them in Elasticsearch, you can view and analyze them with Kibana.</p>

<p><a href="https://github.com/elastic/kibana">Kibana</a> is an open source analytics and visualization platform designed to work with Elasticsearch. You use Kibana to search, view, and interact with data stored in Elasticsearch.</p>

<p>The ELK Stack is a perfect solution for managing logs from our serverless functions.</p>

<p><strong>But how do we configure this solution to automatically index logs from our serverless platform?</strong></p>

<p><em>Let&#8217;s start by looking serverless platform we are using‚Ä¶</em></p>

<h2>OpenWhisk</h2>

<p><a href="https://github.com/openwhisk/openwhisk">OpenWhisk</a> is an open-source serverless platform developed by IBM. Developers <a href="https://github.com/openwhisk/openwhisk/blob/master/docs/actions.md">deploy functions</a> to execute in response to <a href="https://github.com/openwhisk/openwhisk/blob/master/docs/triggers_rules.md">external events</a>, e.g. database updates, messages on a queue or HTTP requests. The platform invokes these functions on-demand in milliseconds, rather than having services sat idle waiting for requests to arrive.</p>

<p><em>Let&#8217;s walk through an example.</em></p>

<h3>Serverless Functions</h3>

<p>Here&#8217;s a sample serverless function which returns a greeting to the user. The code logs the invocation parameters and response message.</p>

<figure class='code'><figcaption><span>logs.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">main</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;invoked with parameters:&#39;</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">user</span> <span class="o">||</span> <span class="s1">&#39;Donald Trump&#39;</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">greeting</span><span class="o">:</span> <span class="err">`</span><span class="nx">Hello</span> <span class="nx">$</span><span class="p">{</span><span class="nx">user</span><span class="p">}</span><span class="err">`</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;returns: &#39;</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">response</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Deploying this serverless function to OpenWhisk and invoking it generates an activation record.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>wsk action create logs logs.js
</span><span class='line'>ok: created action logs
</span><span class='line'><span class="nv">$ </span>wsk action invoke logs -b -r -p user <span class="s1">&#39;Bernie Sanders&#39;</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;greeting&quot;</span>: <span class="s2">&quot;Hello Bernie Sanders&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="nv">$ </span>wsk activation list
</span><span class='line'>activations
</span><span class='line'>2adbbbcc0242457f80dc51944dcd2039                 logs
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>OpenWhisk activation records are available through the <a href="http://petstore.swagger.io/?url=https://raw.githubusercontent.com/openwhisk/openwhisk/master/core/controller/src/main/resources/whiskswagger.json">platform API</a>. Each record contains the stdout and stderr logs generated during the serverless function invocation.</p>

<h3>Serverless Logs</h3>

<p>Retrieving the activation record for the previous invocation, we can see the output generated by the calls to <code>console.log</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>wsk activation get 2adbbbcc0242457f80dc51944dcd2039
</span><span class='line'>ok: got activation 2adbbbcc0242457f80dc51944dcd2039
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;namespace&quot;</span>: <span class="s2">&quot;james.thomas@uk.ibm.com&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;logs&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;version&quot;</span>: <span class="s2">&quot;0.0.3&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;publish&quot;</span>: <span class="nb">false</span>,
</span><span class='line'>    <span class="s2">&quot;subject&quot;</span>: <span class="s2">&quot;james.thomas@uk.ibm.com&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;activationId&quot;</span>: <span class="s2">&quot;2adbbbcc0242457f80dc51944dcd2039&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;start&quot;</span>: 1477925373990,
</span><span class='line'>    <span class="s2">&quot;end&quot;</span>: 1477925374063,
</span><span class='line'>    <span class="s2">&quot;response&quot;</span>: <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;status&quot;</span>: <span class="s2">&quot;success&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;statusCode&quot;</span>: 0,
</span><span class='line'>        <span class="s2">&quot;success&quot;</span>: <span class="nb">true</span>,
</span><span class='line'>        <span class="s2">&quot;result&quot;</span>: <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;greeting&quot;</span>: <span class="s2">&quot;Hello Bernie Sanders&quot;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>,
</span><span class='line'>    <span class="s2">&quot;logs&quot;</span>: <span class="o">[</span>
</span><span class='line'>        <span class="s2">&quot;2016-10-31T14:49:34.059745626Z stdout: invoked with parameters: {}&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;2016-10-31T14:49:34.061228724Z stdout: returns:  { greeting: &#39;Hello Donald Trump&#39; }&quot;</span>
</span><span class='line'>    <span class="o">]</span>,
</span><span class='line'>    ...
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>OpenWhisk stores these records indefinitely, making them available for <a href="http://petstore.swagger.io/?url=https://raw.githubusercontent.com/openwhisk/openwhisk/master/core/controller/src/main/resources/whiskswagger.json#!/Activations/getActivationById">retrieval by the activation id</a>.</p>

<p>However, developers need more than being able to retrieve logs to be effective at diagnosing and resolving issues with serverless functions.</p>

<p>Forwarding these logs to Elasticsearch will enable us to run full-text search across all logs generated, quickly retrieve all output for a particular serverless function, set up monitoring dashboards and much more‚Ä¶</p>

<p>Using Logstash will allow us to ingest and transform OpenWhisk logs into Elasticsearch documents.</p>

<h2>Logstash Input Plugins</h2>

<p>Logstash supports a huge variety of event sources through the use of a <a href="https://www.elastic.co/guide/en/logstash/current/working-with-plugins.html">plugin mechanism</a>. These plugins handle retrieving the external events and converting them to Elasticsearch documents.</p>

<p>Logstash has a huge repository of <a href="https://www.elastic.co/guide/en/logstash/current/input-plugins.html">official and community supported input plugins</a>. These plugins ingest everything from log files, syslog streams, databases, message queues, websockets and much more.</p>

<h3>HTTP Polling Input Plugin</h3>

<p>Logstash already has an input plugin for <a href="https://github.com/logstash-plugins/logstash-input-http_poller">pulling events from a HTTP URL by polling</a>. Users provide the URL in the logstash configuration, along with the polling schedule. Logstash will automatically retrieve and ingest the JSON response as an event stream.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>input <span class="o">{</span>
</span><span class='line'>  http_poller <span class="o">{</span>
</span><span class='line'>    <span class="nv">urls</span> <span class="o">=</span>&gt; <span class="o">{</span>
</span><span class='line'>      <span class="s2">&quot;my_events&quot;</span> <span class="o">=</span>&gt; <span class="s2">&quot;http://localhost:8000/events&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="c"># Poll site every 10s</span>
</span><span class='line'>    <span class="nv">interval</span> <span class="o">=</span>&gt; 10
</span><span class='line'>    <span class="nv">request_timeout</span> <span class="o">=</span>&gt; 60
</span><span class='line'>    <span class="nv">codec</span> <span class="o">=</span>&gt; <span class="s2">&quot;json&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Great, so we can configure this plugin to call OpenWhisk API for retrieving activation records and automatically ingest them into Elasticsearch?</em></p>

<p>Unfortunately not&#8230;</p>

<h3>Polling OpenWhisk Logs?</h3>

<p>Each time the client calls the API to retrieve the activation records, we want to retrieve only those records that have occurred since the last poll. This ensures we are not ingesting the same records more than once.</p>

<p>The <a href="http://petstore.swagger.io/?url=https://raw.githubusercontent.com/openwhisk/openwhisk/master/core/controller/src/main/resources/whiskswagger.json#!/Activations/getActivations">OpenWhisk API for retrieving activation records</a> supports a query parameter (<code>since</code>) which restricts results to those that occurred after the parameter value&#8217;s timestamp.</p>

<p>Using this parameter in the polling URL, updated to the value of the last polling time, will allow us to ensure we only retrieve new activation records.</p>

<p><strong>Unfortunately, the HTTP input plugin does not support setting dynamic query string parameters.</strong></p>

<p>This means we cannot use the existing plugin to efficiently ingest OpenWhisk logs into Elasticsearch.</p>

<p><em>So we started work on a new plugin to support this behaviour‚Ä¶</em></p>

<h3>OpenWhisk Input Plugin</h3>

<p>This <a href="https://github.com/jthomas/logstash-input-openwhisk">input plugin</a> drains logs from OpenWhisk into Elasticsearch.</p>

<p>Install the plugin with the following command.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>bin/logstash-plugin install logstash-input-openwhisk
</span></code></pre></td></tr></table></div></figure>


<p>Once the plugin is installed, you need to configure Logstash with your platform endpoint and user credentials.</p>

<p>This sample configuration will poll the OpenWhisk platform for new logs every fifteen minutes and index them into Elasticsearch. Each activation record will be a separate document.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>input <span class="o">{</span>
</span><span class='line'>  openwhisk <span class="o">{</span>
</span><span class='line'>    <span class="c"># Mandatory Configuration Parameters</span>
</span><span class='line'>    <span class="nv">hostname</span> <span class="o">=</span>&gt; <span class="s2">&quot;openwhisk.ng.bluemix.net&quot;</span>
</span><span class='line'>    <span class="nv">username</span> <span class="o">=</span>&gt; <span class="s2">&quot;sample_user@email.com&quot;</span>
</span><span class='line'>    <span class="nv">password</span> <span class="o">=</span>&gt; <span class="s2">&quot;some_password&quot;</span>
</span><span class='line'>    <span class="c"># Supports &quot;cron&quot;, &quot;every&quot;, &quot;at&quot; and &quot;in&quot; schedules by rufus scheduler</span>
</span><span class='line'>    <span class="nv">schedule</span> <span class="o">=</span>&gt; <span class="o">{</span> <span class="s2">&quot;every&quot;</span> <span class="o">=</span>&gt; <span class="s2">&quot;15m&quot;</span><span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>output <span class="o">{</span>
</span><span class='line'>  elasticsearch <span class="o">{</span>
</span><span class='line'>    <span class="nv">hosts</span> <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">&quot;localhost:9200&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The plugin supports the same configuration values for the <code>schedule</code> parameter as the <a href="https://github.com/logstash-plugins/logstash-input-http_poller">HTTP input plugin</a>.</p>

<p>More examples of using the plugin are available in the <a href="https://github.com/jthomas/logstash-input-openwhisk/tree/master/examples">examples</a> directory in the project repository.</p>

<h2>Demonstration</h2>

<p>Here&#8217;s a demonstration of the OpenWhisk input plugin being used in the ELK stack. As we invoke serverless functions in OpenWhisk, Kibana shows the activation records appearing in the dashboard. Logstash is polling the logs API and ingesting the records into Elasticsearch in real-time.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/9gNyrW58EqE" frameborder="0" allowfullscreen></iframe>


<h2>Conclusion</h2>

<p>Developers using serverless platforms have no access to the infrastructure environment running their code. Debugging production bugs relies on using logging output to diagnose and resolve issues.</p>

<p>Elasticsearch, Logstash and Kibana has become the scalable open-source solution for log management and analysis.</p>

<p>Using the <a href="https://github.com/jthomas/logstash-input-openwhisk">Logstash plugin for OpenWhisk</a>, serverless logs will be automatically indexed into Elasticsearch in real-time. Developers can use the Kibana frontend to easily diagnose and monitor issues in production.</p>

<p>In the next post, we&#8217;ll look at using Docker to set up Elasticsearch, Logstash and Kibana with our custom OpenWhisk plugin.</p>

<p>Until then&#8230; üòé</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/10/10/openwhisk-workshop/">OpenWhisk Workshop</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-10-10T14:51:00+01:00" pubdate data-updated="true">Oct 10<span>th</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="/images/serverless_ldn.png" alt="serverless london" /></p>

<p><a href="http://serverlessconf.io/">Serverless Conference</a> comes to London <a href="http://london.serverlessconf.io/">later this month</a>.</p>

<p>IBM will be hosting a full-day workshop at the event. Developers can come and learn how to use <a href="https://github.com/openwhisk/openwhisk">OpenWhisk</a>, the open-source serverless platform.</p>

<p>I&#8217;m going to be one of the mentors on the day, along with members from the product team.</p>

<p>Working on training material for the session, I remembered that the Node.js community had a popular workshop tool for running training sessions around the world.</p>

<h2>NodeSchool</h2>

<p><a href="http://nodeschool.io/">NodeSchool</a>¬†provides developers with a command-line utility that helps them learn the platform.¬†This tool provides a¬†series of interactive exercises to test their knowledge. Each exercise requires the developers to write some code. The application can then verify their solution and record¬†their progress.</p>

<p>The Node.js community <a href="https://github.com/workshopper">open-sourced the tools</a>¬†used to develop NodeSchool.¬†</p>

<p>Using this toolchain makes¬†it simple to create similar exercise-led workshops for developers.</p>

<h2>OpenWhiskSchool?</h2>

<p>OpenWhisk has great documentation. The <a href="https://github.com/openwhisk/openwhisk/tree/master/docs">project repository includes Markdown files</a> for each feature of the platform.</p>

<p><strong><em>Would it be possible to use this material with the NodeSchool toolchain to create an interactive OpenWhisk workshop for developers?</em></strong></p>

<p>Developers would review the relevant documentation for a particular feature and use the tool to test their knowledge through an interactive exercise.</p>

<p>Each exercise would require them to build, deploy and configure a sample serverless function which used that platform feature.</p>

<p><em>After getting set up with the toolchain and reviewing other example projects, we started work on it‚Ä¶</em></p>

<h2>openwhisk-workshop</h2>

<p>üéâ <strong>Developers can now install the <a href="https://www.npmjs.com/package/openwhisk-workshop">workshop from NPM</a> as a global command.</strong> üéâ</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ npm install -g openwhisk-workshop</span></code></pre></td></tr></table></div></figure>


<p><em>This tool needs the OpenWhisk command-line utility installed and authenticated against an instance of the platform. For more details on getting this environment setup, see the following documentation <a href="https://new-console.ng.bluemix.net/openwhisk/cli">here</a>.</em></p>

<p>Once the tool is installed, developers can open the application by running the following command.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ openwhisk-workshop</span></code></pre></td></tr></table></div></figure>


<p><img src="/images/ow_workshop.png" alt="overview" /></p>

<p>The list of exercises will be displayed, along with current completion progress. Using the arrow keys (<kbd>‚Üë</kbd><kbd>‚Üì</kbd>) to navigate the menu, press <kbd>RETURN</kbd> to open an exercise.</p>

<p>On selecting an exercise, the problem challenge will be printed to the terminal.</p>

<p><img src="/images/challenge.png" alt="exercise" /></p>

<p>Each exercise comes with a documentation page which explains the concepts behind the challenge. Use the following command to display the exercise documentation in the terminal.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ openwhisk-workshop more</span></code></pre></td></tr></table></div></figure>


<p>Once the developer has solved the challenge, they can verify their solution with the following command.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ openwhisk-workshop verify</span></code></pre></td></tr></table></div></figure>


<p>If their solution is correct, that task is marked as completed and the utility returns to the list of exercises.  Developers can continue working through the exercises until they have completed them all.</p>

<p><img src="/images/verify.png" alt="verify" /></p>

<h2>feedback</h2>

<p>If you have problems with the workshop, please <a href="https://github.com/openwhisk/openwhisk-workshop/issues">raise an issue</a> in the repository.</p>

<p><em>Need more general help with OpenWhisk?</em></p>

<ul>
<li><a href="http://stackoverflow.com/questions/tagged/openwhisk">Stack Overflow #openwhisk</a>.</li>
<li><a href="https://developer.ibm.com/open/slackin/">Slack Group #openwhisk</a>.</li>
<li>Twitter <a href="https://twitter.com/openwhisk">@openwhisk</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/09/26/node-red-and-openwhisk/">OpenWhisk and Node-RED</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-09-26T15:16:00+01:00" pubdate data-updated="true">Sep 26<span>th</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://www.npmjs.com/package/node-red-node-openwhisk">Node-RED nodes for OpenWhisk</a> were initially released earlier this year. The nodes allowed users to manually invoke existing Actions and Triggers. This month, a <a href="https://github.com/node-red/node-red-node-openwhisk/releases/tag/0.3.0">new version of the package</a> has been released providing a huge improvement in the functionality‚Ä¶</p>

<h3>features</h3>

<ul>
<li>Users can now define new Actions using the flow editor UI, providing the source code through the inline node configuration panel.</li>
<li>Users can also modify existing Actions, with the live Action source being previewed in the node editor panel.</li>
<li>Triggers can be created and updated in the same way.</li>
<li>Both nodes allow users to view, define and modify default parameters for both Actions and Triggers.</li>
</ul>


<p><em>Deploying the flow will make the modifications to Actions and Triggers live for the configured OpenWhisk platform.</em></p>

<h3>example</h3>

<p>This video shows the updated nodes being used to define a new OpenWhisk Action, invoking it in response to a message from an inject node and then making modifications to the source code.</p>

<p><img src="/images/NR_and_OW.gif"></p>

<h3>interested?</h3>

<p>Grab the <a href="https://www.npmjs.com/package/node-red-node-openwhisk">updated NPM package</a> to test the new features out today‚Ä¶</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/3/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2018/01/21/lessons-from-west-berkshire-action-for-refugees/">Lessons From West Berkshire Action For Refugees</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/01/19/starting-openwhisk-in-sixty-seconds/">Starting OpenWhisk In Sixty Seconds</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/01/05/visualising-metrics-with-grafana-dashboards/">Visualising Serverless Metrics With Grafana Dashboards</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/12/18/capturing-runtime-metrics-for-openwhisk-applications/">Capturing Runtime Metrics For OpenWhisk Applications</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/12/15/serverless-applications-metrics-and-monitoring/">Monitoring Serverless Applications Metrics</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("thomasj", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/thomasj" class="twitter-follow-button" data-show-count="false">Follow @thomasj</a>
  
</section>


<section>
  <h1>My Pinboard</h1>
  <ul id="pinboard_linkroll">Fetching linkroll&#8230;</ul>
  <p><a href="http://pinboard.in/u:jamesthomas">My Pinboard Bookmarks &raquo;</a></p>
</section>
<script type="text/javascript">
  var linkroll = 'pinboard_linkroll'; //id target for pinboard list
  var pinboard_user = "jamesthomas"; //id target for pinboard list
  var pinboard_count = 3; //id target for pinboard list
  (function(){
    var pinboardInit = document.createElement('script');
    pinboardInit.type = 'text/javascript';
    pinboardInit.async = true;
    pinboardInit.src = '/javascripts/pinboard.js';
    document.getElementsByTagName('head')[0].appendChild(pinboardInit);
  })();
</script>




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - James Thomas -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'notesonjavascript';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
